
================================================================================
–ü–†–û–ï–ö–¢: .
–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: 2025-12-12 01:03:58
–ü—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É: /home/k/project/Slavik/slavikai
================================================================================

================================================================================
üìÅ –§–ê–ô–õ: scripts/check.sh
üìä –†–∞–∑–º–µ—Ä: 1014 –±–∞–π—Ç (1014B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/scripts/check.sh
================================================================================

#!/usr/bin/env bash
set -euo pipefail

# Go to project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$PROJECT_ROOT"

echo "================================================="
echo "   üîç Running full project quality check"
echo "================================================="
echo

run_step() {
    local name="$1"
    shift
    echo "‚ñ∂ $name..."
    if "$@"; then
        echo "‚úì $name: OK"
    else
        echo "‚úó $name: FAILED"
        exit 1
    fi
    echo
}

# 1. Ruff lint
run_step "Ruff lint" \
    ruff check .

# 2. Ruff formatting
run_step "Ruff format check" \
    ruff format --check .

# 3. MyPy strict typing
run_step "MyPy strict" \
    mypy .

# 4. Pytest with coverage threshold
run_step "Pytest + Coverage >= 80%" \
    pytest --cov --cov-fail-under=80

echo "================================================="
echo "   üéâ All checks passed successfully!"
echo "================================================="




================================================================================
üìÅ –§–ê–ô–õ: requirements.txt
üìä –†–∞–∑–º–µ—Ä: 642 –±–∞–π—Ç (642B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/requirements.txt
================================================================================

aiohttp>=3.9.1
aiodns>=3.1.1
aiosignal>=1.3.1
async-timeout>=4.0.3
attrs>=23.2.0

certifi>=2023.11.17
chardet>=5.2.0
click>=8.1.6
colorama>=0.4.6
cryptography>=41.0.7
idna>=3.6

Jinja2>=3.1.2
jsonschema>=4.10.3
packaging>=24.0
psutil>=5.9.8

Pygments>=2.17.2
PyYAML>=6.0.1
python-dateutil>=2.8.2
python-dotenv>=1.0.1
pytz>=2024.1
rich>=13.7.1
urllib3>=2.0.7
websocket-client>=1.7.0
yarl>=1.8.2

numpy>=1.26.4
sentence-transformers>=2.7.0
PySide6>=6.7.0
pillow>=10.3.0
pydantic>=2.7.0
mypy>=1.11.0
types-requests>=2.32.0.20240907
types-Pillow>=10.2.0.20240520
PySide6-stubs>=6.7.0

pytest>=8.3.0
pytest-cov>=5.0.0
ruff>=0.6.9
requests>=2.31.0



================================================================================
üìÅ –§–ê–ô–õ: PROJECT_OVERVIEW.md
üìä –†–∞–∑–º–µ—Ä: 3615 –±–∞–π—Ç (3KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/PROJECT_OVERVIEW.md
================================================================================

# Slavik AI Desktop Assistant ‚Äî Overview

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–õ–æ–∫–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å PySide6 UI, —Å–ø–æ—Å–æ–±–Ω—ã–π —Å—Ç—Ä–æ–∏—Ç—å –ø–ª–∞–Ω—ã, –≤—ã–∑—ã–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (—Ñ–∞–π–ª—ã, shell, web, –ø—Ä–æ–µ–∫—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å, workspace, TTS/STT, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è), —Ö—Ä–∞–Ω–∏—Ç—å –ø–∞–º—è—Ç—å –∏ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –∏–Ω–¥–µ–∫—Å, —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ä–µ–∂–∏–º–∞—Ö DualBrain (–æ—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å + –∫—Ä–∏—Ç–∏–∫).

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–ø–æ—Ç–æ–∫)
Agent ‚Üí Planner ‚Üí Executor ‚Üí ToolRegistry ‚Üí Tools ‚Üí Memory/VectorIndex ‚Üí UI/Workspace.
- –ö–æ–º–∞–Ω–¥—ã `/fs|/web|/sh|/project|/img...` –∏–¥—É—Ç –Ω–∞–ø—Ä—è–º—É—é –≤ ToolRegistry.
- –û–±—ã—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã: –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ‚Üí –ø–ª–∞–Ω (LLM/—ç–≤—Ä–∏—Å—Ç–∏–∫–∞, 2‚Äì8 —à–∞–≥–æ–≤) ‚Üí –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∫—Ä–∏—Ç–∏–∫–∞ –ø–ª–∞–Ω–∞/—à–∞–≥–æ–≤ ‚Üí –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏. –ü—Ä–æ—Å—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é LLM —Å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (memory, feedback hints, prefs, vector search, workspace).
- –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç—å, —Ç—Ä–∞—Å—Å–∏—Ä—É–µ—Ç—Å—è –≤ `logs/trace.log`; –≤—ã–∑–æ–≤—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ ‚Äî –≤ `logs/tool_calls.log`.

## –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
- fs (sandbox `sandbox/`, –ª–∏–º–∏—Ç—ã —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏), shell (whitelist, cwd `sandbox`, –±–µ–∑ —Ü–µ–ø–æ—á–µ–∫ –∏ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –ø—É—Ç–µ–π), web search/fetch (Serper/http/https), project index/search (VectorIndex, –ø–æ–∫–∞ –±–µ–∑ sandbox), workspace list/read/write/patch/run (sandbox/project, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è .py/.md/.txt/.json/.toml/.yaml/.yml, run .py), TTS/STT (HTTP), image analyze/generate (–ª–æ–∫–∞–ª—å–Ω–æ), http client —Å –ª–∏–º–∏—Ç–∞–º–∏.
- Safe Mode –≤ —Ä–µ–µ—Å—Ç—Ä–µ –æ—Ç–∫–ª—é—á–∞–µ—Ç web –∏ shell; –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–µ—Ç–µ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è.

## –ü–∞–º—è—Ç—å, –∏–Ω–¥–µ–∫—Å, feedback
- `MemoryManager` (SQLite) ‚Äî –∑–∞–ø–∏—Å–∏ note/user_pref/project_fact —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π; `FeedbackManager` ‚Äî rating/severity/hint, auto-–∏–Ω–∂–µ–∫—Ç major/fatal –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç.
- `VectorIndex` –Ω–∞ sentence-transformers: namespaces `code`/`docs`, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞/—Ä–∞–∑–º–µ—Ä–∞, –ø–æ–∏—Å–∫ cosine.

## UI/Workspace
- `ui/main_window.py`: –ø–∞–Ω–µ–ª–∏ Mode (single/dual/critic-only), Tools (toggle + Safe Mode), Chat (TTS/STT, feedback), Reasoning/Trace/ToolLogs, Memory/Docs/Feedback, Workspace (—Ä–µ–¥–∞–∫—Ç–æ—Ä, patch preview, run .py, –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è LLM).
- Workspace —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ `sandbox/project`; patch ‚Äî single-file unified diff; run ‚Äî `python` —Å —Ç–∞–π–º–∞—É—Ç–æ–º.

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ —Ä–µ–∂–∏–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- Sandbox: fs/shell/workspace –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ `sandbox`; project index –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω.
- Safe Mode: –±–ª–æ–∫–∏—Ä—É–µ—Ç web/shell —Ç–æ–ª—å–∫–æ –≤ ToolRegistry.
- –õ–∏–º–∏—Ç—ã: fs read/write, shell timeout/output, workspace —Ñ–∞–π–ª –¥–æ 2 MB, HTTP max_bytes/max_json_bytes.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
- `core/` (agent/planner/executor/auto_agent/tracer/tool_gateway)
- `tools/` (fs/shell/web/project/workspace/http/tts/stt/image/tool_registry)
- `memory/` (memory_manager/feedback_manager/vector_index)
- `llm/` (brains, dual, factory, types)
- `ui/` (–ø–∞–Ω–µ–ª–∏, audio, workspace)
- `config/` (mode/tools/model/system_prompts/*)
- `tests/` (—é–Ω–∏—Ç—ã –¥–ª—è core/tools/memory/index/web/shell/safe-mode/workspace/llm)
- `sandbox/`, `logs/`, `requirements.txt`, `pyproject.toml`



================================================================================
üìÅ –§–ê–ô–õ: updated_roadmap.md
üìä –†–∞–∑–º–µ—Ä: 3120 –±–∞–π—Ç (3KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/updated_roadmap.md
================================================================================

# Updated Roadmap ‚Äî Stage A —Ñ–∏–∫—Å–∞—Ü–∏—è

## Stage A ‚Äî –Ø–¥—Ä–æ –∞–≥–µ–Ω—Ç–∞
- **–°–¥–µ–ª–∞–Ω–æ:** Agent/Planner/Executor —Å DualBrain (single/dual/critic-only), –∫—Ä–∏—Ç–∏–∫–∞ –ø–ª–∞–Ω–∞/—à–∞–≥–æ–≤; ToolRegistry —Å Safe Mode (web/shell) –∏ –ª–æ–≥–æ–º –≤—ã–∑–æ–≤–æ–≤; Tracer; –ø–∞–º—è—Ç—å/feedback —Å –∞–≤—Ç–æ-–∏–Ω–∂–µ–∫—Ç–æ–º major/fatal; VectorIndex (code/docs, prune); –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã fs/shell/web/project/image/tts/stt/http/workspace; –∫–æ–Ω—Ç–µ–∫—Å—Ç LLM —Å memory+feedback+prefs+vector+workspace; —Ç–µ—Å—Ç—ã —Å –ø–æ—Ä–æ–≥–æ–º –ø–æ–∫—Ä—ã—Ç–∏—è 80%.
- **–ß–∞—Å—Ç–∏—á–Ω–æ:** –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫/Executor –≤—ã–±–∏—Ä–∞—é—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º; Safe Mode –Ω–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç TTS/STT/web-fetch/project; ProjectTool –±–µ–∑ sandbox; UI —Å–æ–∑–¥–∞—ë—Ç DummyBrain, –Ω–µ —á–∏—Ç–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏; VectorIndex –∑–∞–≥—Ä—É–∂–∞–µ—Ç –º–æ–¥–µ–ª—å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ; AutoAgent –±–µ–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.
- **–ù–µ —Å–¥–µ–ª–∞–Ω–æ / NOT IMPLEMENTED:** CI/CD; API/CLI/headless —Ä–µ–∂–∏–º; —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–∫–≤–æ—Ç—ã, RBAC).
- **–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –°–∞–Ω–±–æ–∫—Å –∏ safe-mode –æ—Ö–≤–∞—Ç –¥–ª—è project/tts/stt/web-fetch; —è–≤–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ —à–∞–≥‚Üí–æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ Executor; –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö Brain-–∫–æ–Ω—Ñ–∏–≥–æ–≤ –≤ UI; –ª–µ–Ω–∏–≤—ã–π/cached VectorIndex; –¥–æ–±–∞–≤–∏—Ç—å CI (ruff/mypy/pytest --cov>=80).

## Stage B ‚Äî Workspace —Å–ª–æ–π
- **–°–¥–µ–ª–∞–Ω–æ:** Workspace –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (list/read/write/patch/run) —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π/—Ä–∞–∑–º–µ—Ä–∞ –∏ sandbox/project; UI-—Ä–µ–¥–∞–∫—Ç–æ—Ä —Å diff preview, run .py, –ø–µ—Ä–µ–¥–∞—á–µ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞/selection –≤ LLM.
- **–ß–∞—Å—Ç–∏—á–Ω–æ:** Patch ‚Äî —Ç–æ–ª—å–∫–æ single-file; –Ω–µ—Ç –ª–∏–º–∏—Ç–∞ –Ω–∞ —Ä–∞–∑–º–µ—Ä –ø–∞—Ç—á–∞; run –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ª–∏–Ω—Ç/—Ç–µ—Å—Ç—ã; ProjectTool –æ–±—Ö–æ–¥–∏—Ç sandbox; –Ω–µ—Ç —Ñ–æ–Ω–æ–≤—ã—Ö –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–π.
- **–ù–µ —Å–¥–µ–ª–∞–Ω–æ / NOT IMPLEMENTED:** –ú–Ω–æ–≥–æ—Ñ–∞–π–ª–æ–≤—ã–µ –ø–∞—Ç—á–∏, commit/–≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ workspace, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è lint/test runner –≤ UI.
- **–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –£—Å–∏–ª–∏—Ç—å patch (–ª–∏–º–∏—Ç—ã, –º–Ω–æ–≥–æ—Ñ–∞–π–ª–æ–≤—ã–µ), –∑–∞—Å–∞–Ω–¥–±–æ–∫—Å–∏—Ç—å project index, –¥–æ–±–∞–≤–∏—Ç—å –æ–ø—Ü–∏–∏ –ª–∏–Ω—Ç/—Ç–µ—Å—Ç–æ–≤ –≤ WorkspaceRun, –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é –≤ —Ñ–æ–Ω–µ.

## Stage C ‚Äî –†–∞—Å—à–∏—Ä–µ–Ω–∏—è
- **–°–¥–µ–ª–∞–Ω–æ:** TTS/STT —á–µ—Ä–µ–∑ HTTP —Å UI-–∫–Ω–æ–ø–∫–∞–º–∏/–∑–∞–ø–∏—Å—å—é.
- **–ß–∞—Å—Ç–∏—á–Ω–æ:** –ù–µ—Ç Safe Mode –¥–ª—è –∞—É–¥–∏–æ/—Å–µ—Ç–µ–≤—ã—Ö –≤—ã–∑–æ–≤–æ–≤; –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ—Ñ–ª–∞–π–Ω TTS/STT.
- **–ù–µ —Å–¥–µ–ª–∞–Ω–æ / NOT IMPLEMENTED:** Web/Mobile –∫–ª–∏–µ–Ω—Ç—ã; REST/WebSocket API; —É–¥–∞–ª—ë–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø/–º—É–ª—å—Ç–∏–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ä–µ–∂–∏–º.
- **–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å API —Å–ª–æ–π (REST/WS) –∏ –∫–ª–∏–µ–Ω—Ç–æ–≤; –¥–æ–±–∞–≤–∏—Ç—å Safe Mode –æ—Ö–≤–∞—Ç –¥–ª—è –∞—É–¥–∏–æ/—Å–µ—Ç–µ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π; —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ñ–ª–∞–π–Ω TTS/STT –∫–∞–∫ fallback.



================================================================================
üìÅ –§–ê–ô–õ: COMMANDS.md
üìä –†–∞–∑–º–µ—Ä: 759 –±–∞–π—Ç (759B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/COMMANDS.md
================================================================================

# üìú –ö–æ–º–∞–Ω–¥—ã SlavikAI Core v0.5

**–û—Å–Ω–æ–≤–Ω—ã–µ:**
- `/fs list` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–∞–π–ª—ã –ø–µ—Å–æ—á–Ω–∏—Ü—ã
- `/fs read <—Ñ–∞–π–ª>` ‚Äî –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª
- `/sh <–∫–æ–º–∞–Ω–¥–∞>` ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–∞—è shell-–∫–æ–º–∞–Ω–¥–∞
- `/web <url>` ‚Äî –ø–æ–ª—É—á–∏—Ç—å web-—Å—Ç—Ä–∞–Ω–∏—Ü—É

**–ü–∞–º—è—Ç—å:**
- `/mem search <—Ç–µ–∫—Å—Ç>` ‚Äî –ø–æ–∏—Å–∫ –≤ –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏

**–í–µ–∫—Ç–æ—Ä–Ω–∞—è –ø–∞–º—è—Ç—å:**
- `/vec search <—Ç–µ–∫—Å—Ç>` ‚Äî —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ embeddings

**–ü—Ä–æ–µ–∫—Ç—ã:**
- `/project index <–ø–∞–ø–∫–∞>` ‚Äî –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã `.py`, `.txt`, `.md`
- `/project find <—Ç–µ–∫—Å—Ç>` ‚Äî –Ω–∞–π—Ç–∏ –ø–æ—Ö–æ–∂–∏–µ —É—á–∞—Å—Ç–∫–∏ –∫–æ–¥–∞



================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_31531f22dffd4f3fb3374762aaff5059.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_31531f22dffd4f3fb3374762aaff5059.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_9af82443e76f4ff1becec5f12d928937.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_9af82443e76f4ff1becec5f12d928937.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_4b29060aa23c429aa04288bc6dda1733.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_4b29060aa23c429aa04288bc6dda1733.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_6d547e0300fc444d94a4db77aaeab98a.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_6d547e0300fc444d94a4db77aaeab98a.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_f9d34354dbe245acb82108db6f811334.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_f9d34354dbe245acb82108db6f811334.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_3c23c5a2250642b58b80d76149f5b855.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_3c23c5a2250642b58b80d76149f5b855.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_b2f3eaaeb9fb4104b717935e9c54f2a1.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_b2f3eaaeb9fb4104b717935e9c54f2a1.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_9e963b05776d422084e34136aec68539.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_9e963b05776d422084e34136aec68539.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_a54ba78ef830478dbd2d77d42fe0ae4e.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_a54ba78ef830478dbd2d77d42fe0ae4e.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_4e499f7e94564a9686f26cf11ce76f2c.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_4e499f7e94564a9686f26cf11ce76f2c.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_30e3cc5db7464fbc98d741591268bb2f.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_30e3cc5db7464fbc98d741591268bb2f.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_b0ba9708b9ed47f89d09d6bc23072c40.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_b0ba9708b9ed47f89d09d6bc23072c40.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_0d1e2520d7af469a8644e601a79a718b.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_0d1e2520d7af469a8644e601a79a718b.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_50d1d04b302a4f988ce46ed76cd25de6.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_50d1d04b302a4f988ce46ed76cd25de6.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_6779ac3628a743e09619cf3df888217e.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_6779ac3628a743e09619cf3df888217e.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_e85abde1bb554adf84118aaac059736c.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_e85abde1bb554adf84118aaac059736c.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_f397076449be47d49ff2d7c61ebe4402.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_f397076449be47d49ff2d7c61ebe4402.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_7e094f59015b4a35bd22bd33e9f0639d.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_7e094f59015b4a35bd22bd33e9f0639d.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_3300d31c8c55400ab0b5577b8d07d74e.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_3300d31c8c55400ab0b5577b8d07d74e.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_9ed2d08cdbd74c13959d0803f71e3e0c.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_9ed2d08cdbd74c13959d0803f71e3e0c.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_6f41af707214480eb9070c41eaa40db7.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_6f41af707214480eb9070c41eaa40db7.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_8060917824e94e5a8b5bcd0856d2c3ab.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_8060917824e94e5a8b5bcd0856d2c3ab.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_52b1271307ec4c7aa7e9d3f62174dc19.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_52b1271307ec4c7aa7e9d3f62174dc19.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_12bbd94c031a472dbb7a2500271216a0.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_12bbd94c031a472dbb7a2500271216a0.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_80e1af893b6147429429df0fe801e5ae.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_80e1af893b6147429429df0fe801e5ae.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/project/nested/sample.txt
üìä –†–∞–∑–º–µ—Ä: 12 –±–∞–π—Ç (12B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/project/nested/sample.txt
================================================================================

line1
line2



================================================================================
üìÅ –§–ê–ô–õ: sandbox/project/patch_me.txt
üìä –†–∞–∑–º–µ—Ä: 12 –±–∞–π—Ç (12B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/project/patch_me.txt
================================================================================

HELLO
world



================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_ea358254454e488f9c61900526a5bef2.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_ea358254454e488f9c61900526a5bef2.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_cd5e3cb53e534bb98753956abc585372.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_cd5e3cb53e534bb98753956abc585372.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_36293393157546f4bfd8f92663ded1a7.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_36293393157546f4bfd8f92663ded1a7.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_b805543f44114e3baf2831255a56c281.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_b805543f44114e3baf2831255a56c281.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_9ac2f871c6144a5b8bf5be098a9ee3b2.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_9ac2f871c6144a5b8bf5be098a9ee3b2.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_1429ba642b62450c8eb1e9a7555386e6.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_1429ba642b62450c8eb1e9a7555386e6.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: sandbox/test_c5f891a1a1574c5b85a242cf84d0c7de.txt
üìä –†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç (11B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/sandbox/test_c5f891a1a1574c5b85a242cf84d0c7de.txt
================================================================================

hello world


================================================================================
üìÅ –§–ê–ô–õ: tests/test_shell_config_defaults.py
üìä –†–∞–∑–º–µ—Ä: 589 –±–∞–π—Ç (589B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_shell_config_defaults.py
================================================================================

from __future__ import annotations

from config.shell_config import load_shell_config, save_shell_config


def test_shell_config_defaults(tmp_path) -> None:
    cfg = load_shell_config(tmp_path / "missing.json")
    assert cfg.allowed_commands
    cfg.timeout_seconds = 5
    cfg.max_output_chars = 100
    cfg.sandbox_root = "tmp_sandbox"
    save_path = tmp_path / "saved.json"
    save_shell_config(cfg, save_path)
    loaded = load_shell_config(save_path)
    assert loaded.timeout_seconds == 5
    assert loaded.max_output_chars == 100
    assert loaded.sandbox_root == "tmp_sandbox"



================================================================================
üìÅ –§–ê–ô–õ: tests/test_auto_agent_error.py
üìä –†–∞–∑–º–µ—Ä: 664 –±–∞–π—Ç (664B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_auto_agent_error.py
================================================================================

from __future__ import annotations

from core.auto_agent import AutoAgent
from llm.brain_base import Brain
from llm.types import LLMResult, ModelConfig
from shared.models import LLMMessage


class FailingBrain(Brain):
    def generate(self, messages: list[LLMMessage], config: ModelConfig | None = None) -> LLMResult:
        raise RuntimeError("fail")


class Parent:
    def __init__(self) -> None:
        self.brain = FailingBrain()


def test_auto_agent_handles_errors() -> None:
    auto = AutoAgent(Parent())
    subtasks = ["a"]
    results = auto.run_parallel(subtasks)
    assert results  # at least one result
    assert "–û—à–∏–±–∫–∞" in results[0][1]



================================================================================
üìÅ –§–ê–ô–õ: tests/test_model_store.py
üìä –†–∞–∑–º–µ—Ä: 886 –±–∞–π—Ç (886B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_model_store.py
================================================================================

from __future__ import annotations

import json
from pathlib import Path

from config.model_store import (
    load_model_configs,
    model_config_from_dict,
    model_config_to_dict,
    save_model_configs,
)
from llm.types import ModelConfig


def test_model_config_roundtrip(tmp_path: Path) -> None:
    cfg = ModelConfig(
        provider="openrouter",
        model="gpt-test",
        temperature=0.5,
        max_tokens=128,
        system_prompt="hi",
    )
    path = tmp_path / "model.json"
    save_model_configs(cfg, None, path)
    loaded_main, loaded_critic = load_model_configs(path)
    assert loaded_critic is None
    assert loaded_main and loaded_main.model == "gpt-test"

    data = model_config_to_dict(cfg)
    roundtrip = model_config_from_dict(data)
    assert roundtrip.model == cfg.model
    assert json.loads(path.read_text())["main"]["model"] == "gpt-test"



================================================================================
üìÅ –§–ê–ô–õ: tests/test_agent_commands.py
üìä –†–∞–∑–º–µ—Ä: 824 –±–∞–π—Ç (824B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_agent_commands.py
================================================================================

from __future__ import annotations

from core.agent import Agent
from llm.brain_base import Brain
from llm.types import LLMResult, ModelConfig
from shared.models import LLMMessage


class SimpleBrain(Brain):
    def generate(self, messages: list[LLMMessage], config: ModelConfig | None = None) -> LLMResult:
        return LLMResult(text="ok")


def test_agent_unknown_tool_command() -> None:
    agent = Agent(brain=SimpleBrain())
    resp = agent.handle_tool_command("/unknown")
    assert "–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω" in resp.lower() or "–Ω–µ–∞–∫—Ç–∏–≤–µ–Ω" in resp.lower()


def test_agent_shell_disabled_in_safe_mode() -> None:
    agent = Agent(brain=SimpleBrain(), enable_tools={"safe_mode": True})
    resp = agent.handle_tool_command("/sh ls")
    assert "safe mode" in resp.lower() or "–æ—Ç–∫–ª—é—á—ë–Ω" in resp.lower()



================================================================================
üìÅ –§–ê–ô–õ: tests/test_memory_validation.py
üìä –†–∞–∑–º–µ—Ä: 1360 –±–∞–π—Ç (1KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_memory_validation.py
================================================================================

from __future__ import annotations

import pytest

from memory.memory_manager import MemoryManager
from shared.models import MemoryKind, MemoryRecord, ProjectFact, UserPreference


def test_memory_record_validation_rejects_empty_content(tmp_path) -> None:
    manager = MemoryManager(str(tmp_path / "mem.db"))
    bad = MemoryRecord(
        id="1",
        kind=MemoryKind.NOTE,
        content="",
        tags=[],
        timestamp="2024-01-01",
    )
    with pytest.raises(ValueError):
        manager.save(bad)


def test_user_pref_validation(tmp_path) -> None:
    manager = MemoryManager(str(tmp_path / "mem.db"))
    pref = UserPreference(
        id="pref1",
        key="theme",
        value="dark",
        timestamp="2024-01-01",
        tags=["ui"],
    )
    manager.save_user_pref(pref)
    prefs = manager.get_user_prefs("theme")
    assert prefs
    assert prefs[0].meta.get("value") == "dark"


def test_project_fact_validation(tmp_path) -> None:
    manager = MemoryManager(str(tmp_path / "mem.db"))
    fact = ProjectFact(
        id="f1",
        project="proj",
        content="uses FastAPI",
        timestamp="2024-02-02",
        tags=["tech"],
        meta={"author": "me"},
    )
    manager.save_project_fact(fact)
    facts = manager.get_project_facts("proj")
    assert len(facts) == 1
    assert "FastAPI" in facts[0].content



================================================================================
üìÅ –§–ê–ô–õ: tests/test_agent_safe_modes.py
üìä –†–∞–∑–º–µ—Ä: 1767 –±–∞–π—Ç (1KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_agent_safe_modes.py
================================================================================

from __future__ import annotations

from core.agent import Agent
from llm.brain_base import Brain
from llm.types import LLMResult, ModelConfig
from shared.models import LLMMessage, ToolRequest, ToolResult
from tools.tool_registry import ToolRegistry


class SimpleBrain(Brain):
    def generate(
        self, messages: list[LLMMessage], config: ModelConfig | None = None
    ) -> LLMResult:
        return LLMResult(text="ok")


class DummyTool:
    def __init__(self) -> None:
        self.calls = 0

    def handle(self, request: ToolRequest) -> ToolResult:
        self.calls += 1
        return ToolResult.success({"output": request.name})


def test_safe_mode_off_allows_tools() -> None:
    agent = Agent(brain=SimpleBrain())
    registry = ToolRegistry(safe_block={"web", "shell"})
    dummy = DummyTool()
    registry.register("web", dummy, enabled=True)
    registry.apply_safe_mode(False)
    agent.tool_registry = registry

    result = agent.tool_registry.call(ToolRequest(name="web", args={}))
    assert result.ok
    assert dummy.calls == 1


def test_safe_mode_on_blocks_web_shell() -> None:
    agent = Agent(brain=SimpleBrain())
    registry = ToolRegistry(safe_block={"web", "shell"})
    dummy = DummyTool()
    registry.register("web", dummy, enabled=True)
    registry.register("shell", dummy, enabled=True)
    registry.apply_safe_mode(True)
    agent.tool_registry = registry

    res_web = agent.tool_registry.call(ToolRequest(name="web", args={}))
    res_shell = agent.tool_registry.call(ToolRequest(name="shell", args={"command": "ls"}))
    assert not res_web.ok and res_web.error
    assert not res_shell.ok and res_shell.error
    assert "Safe mode" in res_web.error or "safe mode" in res_web.error.lower()
    assert dummy.calls == 0



================================================================================
üìÅ –§–ê–ô–õ: tests/test_web_search_tool.py
üìä –†–∞–∑–º–µ—Ä: 2176 –±–∞–π—Ç (2KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_web_search_tool.py
================================================================================

from __future__ import annotations

from typing import Any

from config.web_search_config import WebSearchConfig
from shared.models import ToolRequest
from tools.http_client import HttpResult
from tools.web_search_tool import SERPER_ENDPOINT, WebSearchTool


class FakeHttpClient:
    def __init__(self) -> None:
        self.calls: list[tuple[str, dict[str, Any]]] = []

    def post_json(self, url: str, **kwargs: Any) -> HttpResult:
        self.calls.append((url, kwargs))
        payload = {
            "organic": [
                {"title": "Result 1", "link": "https://example.com/1", "snippet": "Snippet 1"},
                {"title": "Result 2", "link": "https://example.com/2", "snippet": "Snippet 2"},
            ]
        }
        return HttpResult(ok=True, data=payload, status_code=200, error=None, headers={}, meta={})

    def get_text(self, url: str, **kwargs: Any) -> HttpResult:
        self.calls.append((url, kwargs))
        return HttpResult(
            ok=True,
            data="hello world",
            status_code=200,
            error=None,
            headers={},
            meta={},
        )


def test_web_search_serper() -> None:
    fake_http = FakeHttpClient()
    config = WebSearchConfig(api_key="test-key")
    tool = WebSearchTool(config=config, http_client=fake_http)
    result = tool.handle(ToolRequest(name="web", args={"query": "hello"}))
    assert result.ok
    assert fake_http.calls[0][0] == SERPER_ENDPOINT
    assert fake_http.calls[0][1]["headers"]["X-API-KEY"] == "test-key"
    assert len(result.data.get("results") or []) == 2
    scores = [entry["score"] for entry in result.data.get("results") or []]
    assert scores == sorted(scores, reverse=True)


def test_web_search_bad_url() -> None:
    tool = WebSearchTool()
    result = tool.handle(ToolRequest(name="web", args={"query": "ftp://example.com"}))
    assert not result.ok


def test_web_fetch() -> None:
    fake_http = FakeHttpClient()
    tool = WebSearchTool(http_client=fake_http)
    result = tool.handle(ToolRequest(name="web", args={"query": "https://example.com"}))
    assert result.ok
    assert "hello world" in str(result.data.get("output"))



================================================================================
üìÅ –§–ê–ô–õ: tests/test_shell_config.py
üìä –†–∞–∑–º–µ—Ä: 695 –±–∞–π—Ç (695B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_shell_config.py
================================================================================

from __future__ import annotations

from config.shell_config import ShellConfig
from tools.shell_tool import handle_shell


def test_shell_respects_custom_allowed(tmp_path) -> None:
    cfg = ShellConfig(
        allowed_commands=["echo"],
        timeout_seconds=2,
        max_output_chars=100,
        sandbox_root=str(tmp_path),
    )
    result = handle_shell("echo hi", config=cfg)
    assert result.ok


def test_shell_blocks_unlisted_command(tmp_path) -> None:
    cfg = ShellConfig(
        allowed_commands=["echo"],
        timeout_seconds=2,
        max_output_chars=100,
        sandbox_root=str(tmp_path),
    )
    result = handle_shell("ls", config=cfg)
    assert not result.ok



================================================================================
üìÅ –§–ê–ô–õ: tests/test_workspace_tools.py
üìä –†–∞–∑–º–µ—Ä: 3780 –±–∞–π—Ç (3KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_workspace_tools.py
================================================================================

from __future__ import annotations

import shutil
from pathlib import Path

from shared.models import ToolRequest
from tools.workspace_tools import (
    WORKSPACE_ROOT,
    ApplyPatchTool,
    ListFilesTool,
    ReadFileTool,
    RunCodeTool,
    WriteFileTool,
)


def _make_request(name: str, args: dict[str, object]) -> ToolRequest:
    return ToolRequest(name=name, args=args)


def test_read_write_and_list_files() -> None:
    (WORKSPACE_ROOT / "nested").mkdir(parents=True, exist_ok=True)
    write = WriteFileTool()
    target_path = "nested/sample.txt"
    content = "line1\nline2\n"
    write_result = write.handle(
        _make_request("workspace_write", {"path": target_path, "content": content})
    )
    assert write_result.ok

    read = ReadFileTool().handle(_make_request("workspace_read", {"path": target_path}))
    assert read.ok
    assert read.data["output"] == content

    tree_result = ListFilesTool().handle(_make_request("workspace_list", {}))
    assert tree_result.ok
    paths = _flatten_paths(tree_result.data["tree"])
    assert target_path in paths


def test_apply_patch_dry_run_and_apply() -> None:
    file_path = "patch_me.txt"
    WriteFileTool().handle(
        _make_request("workspace_write", {"path": file_path, "content": "hello\nworld\n"})
    )
    patch_text = "@@ -1,2 +1,2 @@\n-hello\n+HELLO\n world\n"
    tool = ApplyPatchTool()

    dry = tool.handle(
        _make_request(
            "workspace_patch",
            {"path": file_path, "patch": patch_text, "dry_run": True},
        )
    )
    assert dry.ok
    assert dry.data["dry_run"] is True
    # –§–∞–π–ª –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ dry-run
    still_original = ReadFileTool().handle(_make_request("workspace_read", {"path": file_path}))
    assert still_original.data["output"].startswith("hello")

    applied = tool.handle(
        _make_request(
            "workspace_patch",
            {"path": file_path, "patch": patch_text, "dry_run": False},
        )
    )
    assert applied.ok
    updated = ReadFileTool().handle(_make_request("workspace_read", {"path": file_path}))
    assert updated.data["output"].startswith("HELLO")


def test_apply_patch_rejects_escape() -> None:
    tool = ApplyPatchTool()
    result = tool.handle(
        _make_request(
            "workspace_patch",
            {"path": "../etc/passwd", "patch": "@@ -1,1 +1,1 @@\n-a\n+b\n"},
        )
    )
    assert not result.ok
    assert "—Ä–∞–±–æ—á–µ–π" in (result.error or "").lower()


def test_run_code_success_and_timeout(tmp_path: Path) -> None:
    scripts_dir = WORKSPACE_ROOT / "scripts"
    scripts_dir.mkdir(parents=True, exist_ok=True)
    good_script = scripts_dir / "hello.py"
    good_script.write_text("print('hi')\n", encoding="utf-8")

    result_ok = RunCodeTool(timeout=2).handle(
        _make_request("workspace_run", {"path": str(good_script.relative_to(WORKSPACE_ROOT))})
    )
    assert result_ok.ok
    assert "hi" in str(result_ok.data.get("output"))

    slow_script = scripts_dir / "sleepy.py"
    slow_script.write_text("import time\n\ntime.sleep(5)\n", encoding="utf-8")
    result_timeout = RunCodeTool(timeout=1).handle(
        _make_request("workspace_run", {"path": str(slow_script.relative_to(WORKSPACE_ROOT))})
    )
    assert not result_timeout.ok
    assert "–ø—Ä–µ–≤—ã—à–µ–Ω–æ" in (result_timeout.error or "").lower()

    shutil.rmtree(scripts_dir, ignore_errors=True)


def _flatten_paths(tree: list[dict[str, object]]) -> set[str]:
    collected: set[str] = set()
    for node in tree:
        if node.get("type") == "file":
            path = str(node.get("path") or "")
            collected.add(path)
        for child in node.get("children", []) or []:
            collected.update(_flatten_paths([child]))
    return collected



================================================================================
üìÅ –§–ê–ô–õ: tests/test_config_tools.py
üìä –†–∞–∑–º–µ—Ä: 743 –±–∞–π—Ç (743B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_config_tools.py
================================================================================

from __future__ import annotations

from pathlib import Path

from config.mode_config import load_mode, save_mode
from config.tools_config import ToolsConfig, load_tools_config, save_tools_config


def test_tools_config_roundtrip(tmp_path: Path) -> None:
    path = tmp_path / "tools.json"
    cfg = ToolsConfig(fs=False, shell=True, web=True, project=False, img=True, tts=True, stt=False)
    save_tools_config(cfg, path)

    loaded = load_tools_config(path)
    assert loaded.to_dict() == cfg.to_dict()


def test_mode_config_roundtrip(tmp_path: Path) -> None:
    path = tmp_path / "mode.json"
    save_mode("dual", path)
    assert load_mode(path) == "dual"

    save_mode("critic-only", path)
    assert load_mode(path) == "critic-only"



================================================================================
üìÅ –§–ê–ô–õ: tests/test_http_client.py
üìä –†–∞–∑–º–µ—Ä: 1360 –±–∞–π—Ç (1KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_http_client.py
================================================================================

from __future__ import annotations

from tools.http_client import HttpClient, HttpConfig


class DummyResponse:
    def __init__(self, text: str, status_code: int = 200) -> None:
        self._text = text
        self.status_code = status_code
        self.headers = {}

    def iter_content(self, chunk_size=4096, decode_unicode=True):  # noqa: ANN001
        yield self._text

    def raise_for_status(self) -> None:
        return None


def test_http_client_json_limit(monkeypatch) -> None:
    payload = "{" + '"k":"v"' * 600_000 + "}"
    response = DummyResponse(payload)

    def fake_request(method, url, timeout, stream, **kwargs):  # noqa: ANN001
        return response

    monkeypatch.setattr("tools.http_client.requests.request", fake_request)
    client = HttpClient(HttpConfig(max_json_bytes=1024))
    result = client.post_json("https://example.com")
    assert not result.ok
    assert result.error == "payload_too_large"


def test_http_client_json_ok(monkeypatch) -> None:
    response = DummyResponse('{"ok": true}')

    def fake_request(method, url, timeout, stream, **kwargs):  # noqa: ANN001
        return response

    monkeypatch.setattr("tools.http_client.requests.request", fake_request)
    client = HttpClient()
    result = client.post_json("https://example.com")
    assert result.ok
    assert isinstance(result.data, dict)



================================================================================
üìÅ –§–ê–ô–õ: tests/test_vector_index.py
üìä –†–∞–∑–º–µ—Ä: 2127 –±–∞–π—Ç (2KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_vector_index.py
================================================================================

from __future__ import annotations

import numpy as np
import pytest

from memory.vector_index import VectorIndex


class DummyModel:
    def encode(self, texts):
        # deterministic small vectors
        return np.array([[1.0, 0.0, 0.0] for _ in texts], dtype=np.float32)


def test_vector_index_namespace_and_limit(tmp_path, monkeypatch) -> None:
    db_path = tmp_path / "vec.db"
    monkeypatch.setattr(
        "memory.vector_index.VectorIndex._get_model", lambda self, name: DummyModel()
    )
    index = VectorIndex(str(db_path), max_records=2)

    index.index_text("file1", "content1", namespace="projA")
    index.index_text("file2", "content2", namespace="projA")
    # third insert should prune oldest in namespace
    index.index_text("file3", "content3", namespace="projA")

    results = index.search("query", namespace="projA", top_k=5)
    assert len(results) == 2
    paths = [res.path for res in results]
    assert "file1" not in paths  # pruned

    # other namespace independent
    index.index_text("other", "data", namespace="projB")
    res_other = index.search("x", namespace="projB", top_k=5)
    assert len(res_other) == 1
    assert res_other[0].path == "other"


def test_vector_index_batch_and_total_limit(tmp_path, monkeypatch) -> None:
    db_path = tmp_path / "vec.db"
    monkeypatch.setattr(
        "memory.vector_index.VectorIndex._get_model", lambda self, name: DummyModel()
    )
    index = VectorIndex(str(db_path), max_records=10, max_total_records=3, batch_size=2)
    items = [(f"path{i}", f"content{i}") for i in range(5)]
    index.index_batch(items, namespace="code")
    results = index.search("query", namespace="code", top_k=10)
    assert len(results) == 3  # total pruned to max_total_records


def test_vector_index_rejects_bad_meta(tmp_path, monkeypatch) -> None:
    db_path = tmp_path / "vec.db"
    monkeypatch.setattr(
        "memory.vector_index.VectorIndex._get_model", lambda self, name: DummyModel()
    )
    index = VectorIndex(str(db_path))
    with pytest.raises(ValueError):
        index.index_text("p", "content", namespace="code", meta="not a dict")



================================================================================
üìÅ –§–ê–ô–õ: tests/test_shell_tool_edges.py
üìä –†–∞–∑–º–µ—Ä: 2006 –±–∞–π—Ç (1KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_shell_tool_edges.py
================================================================================

from __future__ import annotations

from shared.models import ToolRequest
from tools.shell_tool import ShellConfig, handle_shell_request


def test_shell_allowed_command(tmp_path) -> None:
    cfg = ShellConfig(
        allowed_commands=["echo"],
        timeout_seconds=2,
        max_output_chars=100,
        sandbox_root=str(tmp_path),
    )
    req = ToolRequest(name="shell", args={"command": "echo hello", "shell_config": cfg.__dict__})
    res = handle_shell_request(req)
    assert res.ok
    assert "hello" in str(res.data.get("output"))


def test_shell_blocks_abs_path(tmp_path) -> None:
    cfg = ShellConfig(allowed_commands=["ls"], sandbox_root=str(tmp_path))
    req = ToolRequest(name="shell", args={"command": "/bin/ls", "shell_config": cfg.__dict__})
    res = handle_shell_request(req)
    assert not res.ok
    assert "–∑–∞–ø—Ä–µ—â" in (res.error or "").lower()


def test_shell_blocks_dangerous_and_chain(tmp_path) -> None:
    cfg = ShellConfig(allowed_commands=["ls"], sandbox_root=str(tmp_path))
    res_rm = handle_shell_request(
        ToolRequest(name="shell", args={"command": "rm -rf /", "shell_config": cfg.__dict__})
    )
    res_chain = handle_shell_request(
        ToolRequest(name="shell", args={"command": "ls; whoami", "shell_config": cfg.__dict__})
    )
    assert not res_rm.ok and not res_chain.ok
    assert "–±–ª–æ–∫" in (res_rm.error or "").lower() or "–æ–ø–∞—Å–Ω" in (res_rm.error or "").lower()
    assert "—Ü–µ–ø–æ—á" in (res_chain.error or "").lower() or "–∑–∞–ø—Ä–µ—â" in (res_chain.error or "").lower()


def test_shell_timeout(tmp_path) -> None:
    cfg = ShellConfig(
        allowed_commands=["sleep"],
        timeout_seconds=1,
        max_output_chars=100,
        sandbox_root=str(tmp_path),
    )
    res = handle_shell_request(
        ToolRequest(name="shell", args={"command": "sleep 2", "shell_config": cfg.__dict__})
    )
    assert not res.ok
    assert "–ª–∏–º–∏—Ç" in (res.error or "").lower() or "timeout" in (res.error or "").lower()



================================================================================
üìÅ –§–ê–ô–õ: tests/test_auto_agent.py
üìä –†–∞–∑–º–µ—Ä: 761 –±–∞–π—Ç (761B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_auto_agent.py
================================================================================

from __future__ import annotations

from core.auto_agent import AutoAgent
from llm.brain_base import Brain
from llm.types import LLMResult, ModelConfig
from shared.models import LLMMessage


class SimpleBrain(Brain):
    def generate(self, messages: list[LLMMessage], config: ModelConfig | None = None) -> LLMResult:
        return LLMResult(text=f"echo:{messages[-1].content}")


class FakeAgent:
    def __init__(self) -> None:
        self.brain = SimpleBrain()


def test_auto_agent_parallel() -> None:
    auto = AutoAgent(FakeAgent())
    tasks = auto.generate_subtasks("–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å")
    assert tasks
    results = auto.run_parallel(tasks[:2])
    assert len(results) == 2
    assert all("echo" in res for _, res in results)



================================================================================
üìÅ –§–ê–ô–õ: tests/test_planner_executor_paths.py
üìä –†–∞–∑–º–µ—Ä: 1620 –±–∞–π—Ç (1KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_planner_executor_paths.py
================================================================================

from __future__ import annotations

from core.executor import Executor
from core.tool_gateway import ToolGateway
from core.tracer import Tracer
from shared.models import PlanStep, PlanStepStatus, TaskPlan, ToolRequest, ToolResult


class FlakyGateway(ToolGateway):
    def __init__(self) -> None:
        super().__init__(None)  # type: ignore[arg-type]
        self.calls = 0

    def call(self, request: ToolRequest) -> ToolResult:  # type: ignore[override]
        self.calls += 1
        if self.calls == 1:
            return ToolResult.success({"output": "ok"})
        return ToolResult.failure("fail")


def test_executor_stops_after_error() -> None:
    tracer = Tracer()
    executor = Executor(tracer)
    plan = TaskPlan(
        goal="test",
        steps=[
            PlanStep(description="web search"),
            PlanStep(description="shell command"),
            PlanStep(description="other"),
        ],
    )
    finished = executor.run(plan, tool_gateway=FlakyGateway())
    assert finished.steps[0].status == PlanStepStatus.DONE
    assert finished.steps[1].status == PlanStepStatus.ERROR
    assert finished.steps[2].status == PlanStepStatus.PENDING


def test_executor_critic_rejects_step() -> None:
    tracer = Tracer()
    executor = Executor(tracer)
    plan = TaskPlan(goal="test", steps=[PlanStep(description="web search")])

    def critic(step: PlanStep):
        return False, "nope"

    finished = executor.run(plan, tool_gateway=FlakyGateway(), critic_callback=critic)
    assert finished.steps[0].status == PlanStepStatus.ERROR
    assert "nope" in (finished.steps[0].result or "")



================================================================================
üìÅ –§–ê–ô–õ: tests/test_feedback_manager.py
üìä –†–∞–∑–º–µ—Ä: 1281 –±–∞–π—Ç (1KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_feedback_manager.py
================================================================================

from __future__ import annotations

from memory.feedback_manager import FeedbackManager


def test_feedback_saves_severity_and_hint(tmp_path) -> None:
    db = tmp_path / "fb.db"
    mgr = FeedbackManager(str(db))
    mgr.save_feedback("q", "a", "bad", severity="major", hint="avoid mistakes")
    hints = mgr.get_recent_hints(1)
    assert hints == ["avoid mistakes"]
    trends = mgr.analyze_trends()
    assert trends.get("bad") == 1.0


def test_feedback_stats_and_top_hints(tmp_path) -> None:
    db = tmp_path / "fb2.db"
    mgr = FeedbackManager(str(db))
    mgr.save_feedback("q1", "a1", "good", severity="minor")
    mgr.save_feedback("q2", "a2", "bad", severity="major", hint="fix facts")
    mgr.save_feedback("q3", "a3", "offtopic", severity="fatal", hint="stay on topic")
    mgr.save_feedback("q4", "a4", "bad", severity="major", hint="fix facts")
    stats = mgr.stats()
    assert stats["ratings"]["bad"] == 2
    assert stats["severity"]["major"] == 2
    assert stats["severity"]["fatal"] == 1
    top_hints = stats["top_hints"]
    assert top_hints[0]["hint"] == "fix facts"
    assert top_hints[0]["count"] == 2
    bad_records = mgr.get_recent_bad(5)
    assert len(bad_records) == 3
    assert all(rec["rating"] in {"bad", "offtopic"} for rec in bad_records)



================================================================================
üìÅ –§–ê–ô–õ: tests/test_executor_paths.py
üìä –†–∞–∑–º–µ—Ä: 1186 –±–∞–π—Ç (1KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_executor_paths.py
================================================================================

from __future__ import annotations

from core.executor import Executor
from core.tool_gateway import ToolGateway
from core.tracer import Tracer
from shared.models import PlanStep, PlanStepStatus, TaskPlan, ToolRequest, ToolResult


class DummyGateway(ToolGateway):
    def __init__(self, ok: bool = True) -> None:
        super().__init__(None)  # type: ignore[arg-type]
        self.ok = ok

    def call(self, request: ToolRequest) -> ToolResult:  # type: ignore[override]
        if self.ok:
            return ToolResult.success({"output": f"done {request.name}"})
        return ToolResult.failure("err")


def test_executor_success_and_error() -> None:
    tracer = Tracer()
    executor = Executor(tracer)
    plan = TaskPlan(goal="test", steps=[PlanStep(description="web"), PlanStep(description="fail")])
    finished = executor.run(plan, tool_gateway=DummyGateway(ok=True), critic_callback=None)
    assert all(step.status == PlanStepStatus.DONE for step in finished.steps[:1])

    finished_error = executor.run(
        plan, tool_gateway=DummyGateway(ok=False), critic_callback=None
    )
    assert any(step.status == PlanStepStatus.ERROR for step in finished_error.steps)



================================================================================
üìÅ –§–ê–ô–õ: tests/test_agent_core_branches.py
üìä –†–∞–∑–º–µ—Ä: 2572 –±–∞–π—Ç (2KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_agent_core_branches.py
================================================================================

from __future__ import annotations

from core.agent import SAFE_MODE_TOOLS_OFF, Agent
from llm.brain_base import Brain
from llm.types import LLMResult, ModelConfig
from shared.models import LLMMessage, ToolRequest, ToolResult
from tools.tool_registry import ToolRegistry


class SimpleBrain(Brain):
    def generate(self, messages: list[LLMMessage], config: ModelConfig | None = None) -> LLMResult:
        return LLMResult(text="ok")


def _dummy_tool(ok: bool, output: str = "done") -> ToolResult:
    if ok:
        return ToolResult.success({"output": output})
    return ToolResult.failure("fail")


def test_image_commands_success_and_error() -> None:
    agent = Agent(brain=SimpleBrain())
    agent.tool_registry = ToolRegistry(safe_block=SAFE_MODE_TOOLS_OFF)
    agent.tool_registry.register(
        "image_generate", lambda req: _dummy_tool(True, "img-ok"), enabled=True
    )
    agent.tool_registry.register("image_analyze", lambda req: _dummy_tool(False), enabled=True)

    ok_resp = agent.handle_tool_command("/imggen prompt")
    assert "img-ok" in ok_resp

    err_resp = agent.handle_tool_command("/imganalyze path")
    assert "–û—à–∏–±–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞" in err_resp


def test_tts_stt_error_paths() -> None:
    agent = Agent(brain=SimpleBrain())
    agent.tool_registry = ToolRegistry(safe_block=SAFE_MODE_TOOLS_OFF)
    agent.tool_registry.register("tts", lambda req: _dummy_tool(False), enabled=True)
    agent.tool_registry.register("stt", lambda req: _dummy_tool(False), enabled=True)

    tts_result = agent.synthesize_speech("hello")
    assert not tts_result.ok
    assert "fail" in (tts_result.error or "")

    stt_result = agent.transcribe_audio("file.wav")
    assert not stt_result.ok
    assert "fail" in (stt_result.error or "")


def test_safe_mode_blocks_web_not_workspace() -> None:
    agent = Agent(brain=SimpleBrain())
    # –∑–∞–º–µ–Ω–∏—Ç—å registry, —á—Ç–æ–±—ã web –≤–∫–ª—é—á–∏—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å safe mode
    agent.tool_registry = ToolRegistry(safe_block=SAFE_MODE_TOOLS_OFF)
    agent.tool_registry.register("web", lambda req: _dummy_tool(True, "ok"), enabled=True)
    agent.tool_registry.register(
        "workspace_list", lambda req: _dummy_tool(True, "ok"), enabled=True
    )

    agent.tool_registry.apply_safe_mode(True)
    web_result = agent.tool_registry.call(ToolRequest(name="web", args={"query": "x"}))
    assert not web_result.ok
    assert "Safe mode" in (web_result.error or "")

    ws_result = agent.tool_registry.call(ToolRequest(name="workspace_list", args={}))
    assert ws_result.ok



================================================================================
üìÅ –§–ê–ô–õ: tests/test_agent_modes.py
üìä –†–∞–∑–º–µ—Ä: 1969 –±–∞–π—Ç (1KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_agent_modes.py
================================================================================

from __future__ import annotations

from typing import Any

from core.agent import Agent
from llm.brain_base import Brain
from llm.types import LLMResult, ModelConfig
from shared.models import LLMMessage


class CounterBrain(Brain):
    def __init__(self) -> None:
        self.calls = 0

    def generate(self, messages: list[LLMMessage], config: ModelConfig | None = None) -> LLMResult:
        self.calls += 1
        return LLMResult(text="ok")


class FakeVectors:
    def search(self, query: str, namespace: str = "default", top_k: int = 5) -> list[Any]:
        return []


class FakeFeedback:
    def get_recent_hints_meta(self, limit: int = 3, severity_filter: list[str] | None = None):
        return [{"hint": "test major", "severity": "major", "timestamp": "now"}]

    def get_recent_hints(self, limit: int = 3, severity_filter: list[str] | None = None):
        return ["test major"]


class FakeMemory:
    def get_recent(self, limit: int, kind=None):
        return []

    def get_user_prefs(self):
        return []


def test_critic_only_does_not_execute_plan() -> None:
    main = CounterBrain()
    critic = CounterBrain()
    agent = Agent(brain=main, critic=critic)
    agent.set_mode("critic-only")
    response = agent.respond([LLMMessage(role="user", content="–ü–ª–∞–Ω –ø–æ—Å—Ç—Ä–æ–π —ç—Ç–æ")])
    assert "–ö—Ä–∏—Ç–∏–∫" in response or response
    assert main.calls == 0  # main –º–æ–¥–µ–ª—å –Ω–µ –≤—ã–∑—ã–≤–∞–ª–∞—Å—å
    assert critic.calls >= 1


def test_context_uses_hints_meta() -> None:
    main = CounterBrain()
    agent = Agent(brain=main)
    agent.vectors = FakeVectors()
    agent.feedback = FakeFeedback()
    agent.memory = FakeMemory()
    ctx = agent._build_context_messages([LLMMessage(role="user", content="hi")], "hi")  # noqa: SLF001
    assert any(msg.role == "system" for msg in ctx)
    assert agent.last_hints_used == ["test major"]
    assert agent.last_hints_meta and agent.last_hints_meta[0]["severity"] == "major"



================================================================================
üìÅ –§–ê–ô–õ: tests/test_agent_response.py
üìä –†–∞–∑–º–µ—Ä: 2699 –±–∞–π—Ç (2KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_agent_response.py
================================================================================

from __future__ import annotations

from core.agent import Agent
from llm.brain_base import Brain
from llm.types import LLMResult, ModelConfig
from shared.models import LLMMessage, PlanStep, PlanStepStatus, TaskPlan


class SimpleBrain(Brain):
    def __init__(self, text: str) -> None:
        self.text = text
        self.calls = 0

    def generate(self, messages: list[LLMMessage], config: ModelConfig | None = None) -> LLMResult:
        self.calls += 1
        return LLMResult(text=self.text)


class FakePlanner:
    def classify_complexity(self, _: str):
        from shared.models import TaskComplexity

        return TaskComplexity.COMPLEX

    def build_plan(self, goal: str, brain=None, model_config=None) -> TaskPlan:
        return TaskPlan(
            goal=goal, steps=[PlanStep(description="step1"), PlanStep(description="step2")]
        )

    def _parse_plan_text(self, text: str):
        return [line.strip() for line in text.splitlines() if line.strip()]


class FakeExecutor:
    def __init__(self) -> None:
        self.run_called = False

    def run(self, plan: TaskPlan, tool_gateway=None, critic_callback=None) -> TaskPlan:
        self.run_called = True
        for step in plan.steps:
            step.status = PlanStepStatus.DONE
            step.result = "ok"
        return plan


def test_agent_simple_response() -> None:
    brain = SimpleBrain("hello")
    agent = Agent(brain=brain)
    agent.memory.get_recent = lambda *args, **kwargs: []  # type: ignore[attr-defined]
    agent.memory.get_user_prefs = lambda: []  # type: ignore[attr-defined]
    agent.vectors.search = lambda *args, **kwargs: []  # type: ignore[attr-defined]
    agent.feedback.get_recent_hints_meta = lambda *args, **kwargs: []  # type: ignore[attr-defined]
    response = agent.respond([LLMMessage(role="user", content="–ø—Ä–∏–≤–µ—Ç")])
    assert "hello" in response
    assert brain.calls >= 1


def test_agent_plan_execution_path() -> None:
    brain = SimpleBrain("ok")
    agent = Agent(brain=brain)
    agent.planner = FakePlanner()  # type: ignore[assignment]
    agent.executor = FakeExecutor()  # type: ignore[assignment]
    agent.memory.get_recent = lambda *args, **kwargs: []  # type: ignore[attr-defined]
    agent.memory.get_user_prefs = lambda: []  # type: ignore[attr-defined]
    agent.vectors.search = lambda *args, **kwargs: []  # type: ignore[attr-defined]
    agent.feedback.get_recent_hints_meta = lambda *args, **kwargs: []  # type: ignore[attr-defined]
    result = agent.respond([LLMMessage(role="user", content="–ø–ª–∞–Ω–∏—Ä—É–π –∑–∞–¥–∞—á—É")])
    assert "step1" in result or "ok" in result
    assert agent.executor.run_called  # type: ignore[attr-defined]



================================================================================
üìÅ –§–ê–ô–õ: tests/__init__.py
üìä –†–∞–∑–º–µ—Ä: 36 –±–∞–π—Ç (36B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/__init__.py
================================================================================

from __future__ import annotations




================================================================================
üìÅ –§–ê–ô–õ: tests/test_tts_stt_tools.py
üìä –†–∞–∑–º–µ—Ä: 2156 –±–∞–π—Ç (2KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_tts_stt_tools.py
================================================================================

from __future__ import annotations

from pathlib import Path

from config.stt_config import SttConfig
from config.tts_config import TtsConfig
from shared.models import ToolRequest
from tools.http_client import HttpResult
from tools.stt_tool import SttTool
from tools.tts_tool import TtsTool


class DummyHttp:
    def __init__(self, payload: bytes | None = None, json_data=None) -> None:
        self.payload = payload
        self.json_data = json_data
        self.called = False

    def post_bytes(self, url, **kwargs):  # noqa: ANN001
        self.called = True
        return HttpResult(
            ok=True,
            data=self.payload or b"audio",
            status_code=200,
            error=None,
            headers={},
            meta={},
        )

    def _request(self, method, url, expect_json, as_bytes, **kwargs):  # noqa: ANN001
        self.called = True
        return HttpResult(
            ok=True,
            data=self.json_data or {"text": "hello", "confidence": 0.9},
            status_code=200,
            error=None,
            headers={},
            meta={},
        )


def test_tts_tool_writes_file(tmp_path, monkeypatch) -> None:
    monkeypatch.setenv("TTS_API_KEY", "key")
    monkeypatch.setenv("TTS_VOICE_ID", "voice")
    http = DummyHttp(payload=b"audio data")
    tool = TtsTool(http, TtsConfig(format="mp3"))
    req = ToolRequest(name="tts", args={"text": "hello"})
    result = tool.handle(req)
    assert result.ok
    file_path = Path(result.data.get("file_path"))
    assert file_path.exists()
    assert http.called


def test_stt_tool_reads_file(tmp_path, monkeypatch) -> None:
    monkeypatch.setenv("STT_API_KEY", "key")
    audio_dir = Path("sandbox/audio")
    audio_dir.mkdir(parents=True, exist_ok=True)
    file_path = audio_dir / "test.wav"
    file_path.write_bytes(b"dummy")
    http = DummyHttp(json_data={"text": "–ø—Ä–∏–≤–µ—Ç", "confidence": 0.5})
    tool = SttTool(http, SttConfig())
    req = ToolRequest(name="stt", args={"file_path": str(file_path)})
    result = tool.handle(req)
    assert result.ok
    assert "–ø—Ä–∏–≤–µ—Ç" in result.data.get("output")
    assert http.called



================================================================================
üìÅ –§–ê–ô–õ: tests/test_project_tool_stub.py
üìä –†–∞–∑–º–µ—Ä: 861 –±–∞–π—Ç (861B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_project_tool_stub.py
================================================================================

from __future__ import annotations

from typing import Any

from shared.models import ToolRequest, VectorSearchResult
from tools.project_tool import handle_project_request


class FakeVectorIndex:
    def __init__(self, *_: Any, **__: Any) -> None:
        pass

    def search(self, query: str, namespace: str = "default", top_k: int = 5):
        return [
            VectorSearchResult(path=f"{namespace}/file.py", snippet=f"{query} snippet", score=0.9)
        ]


def test_project_find_uses_vectors(monkeypatch) -> None:
    monkeypatch.setattr("tools.project_tool.VectorIndex", FakeVectorIndex)
    req = ToolRequest(name="project", args={"cmd": "find", "args": ["foo"]})
    result = handle_project_request(req)
    assert result.ok
    assert "matches" in result.data
    assert result.meta and result.meta.get("matches") == 2  # code + docs namespaces



================================================================================
üìÅ –§–ê–ô–õ: tests/test_executor_critic.py
üìä –†–∞–∑–º–µ—Ä: 1015 –±–∞–π—Ç (1015B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_executor_critic.py
================================================================================

from __future__ import annotations

from core.executor import Executor
from core.tool_gateway import ToolGateway
from core.tracer import Tracer
from shared.models import PlanStep, PlanStepStatus, TaskPlan, ToolRequest, ToolResult


class DummyGateway(ToolGateway):
    def __init__(self) -> None:
        super().__init__(None)  # type: ignore[arg-type]

    def call(self, request: ToolRequest) -> ToolResult:  # type: ignore[override]
        if request.name == "web":
            return ToolResult.success({"output": "ok"})
        return ToolResult.failure("blocked")


def test_executor_critic_rejects() -> None:
    tracer = Tracer()
    executor = Executor(tracer)
    plan = TaskPlan(goal="test", steps=[PlanStep(description="web step")])

    def critic(step: PlanStep):
        return False, "reject"

    finished = executor.run(plan, tool_gateway=DummyGateway(), critic_callback=critic)
    assert finished.steps[0].status == PlanStepStatus.ERROR
    assert "reject" in (finished.steps[0].result or "")



================================================================================
üìÅ –§–ê–ô–õ: tests/test_agent_branches.py
üìä –†–∞–∑–º–µ—Ä: 3042 –±–∞–π—Ç (2KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_agent_branches.py
================================================================================

from __future__ import annotations

import json
from pathlib import Path

from config.mode_config import load_mode, save_mode
from core.agent import Agent
from llm.brain_base import Brain
from llm.types import LLMResult, ModelConfig
from memory.feedback_manager import FeedbackManager
from memory.memory_manager import MemoryManager
from shared.models import LLMMessage, MemoryKind, MemoryRecord, PlanStep, PlanStepStatus, TaskPlan


class ErrorBrain(Brain):
    def generate(self, messages: list[LLMMessage], config: ModelConfig | None = None) -> LLMResult:
        raise RuntimeError("boom")


class SimpleBrain(Brain):
    def __init__(self, text: str = "ok") -> None:
        self.text = text

    def generate(self, messages: list[LLMMessage], config: ModelConfig | None = None) -> LLMResult:
        return LLMResult(text=self.text)


class StubPlanner:
    def __init__(self) -> None:
        self.executed = False

    def build_plan(self, goal: str, brain=None, model_config=None) -> TaskPlan:
        return TaskPlan(goal=goal, steps=[PlanStep(description="step-one")])

    def execute_plan(self, plan: TaskPlan) -> TaskPlan:
        self.executed = True
        for step in plan.steps:
            step.status = PlanStepStatus.DONE
            step.result = "done"
        return plan


def test_agent_llm_error_path(tmp_path: Path) -> None:
    agent = Agent(brain=ErrorBrain())
    agent.memory = MemoryManager(str(tmp_path / "mem.db"))
    agent.feedback = FeedbackManager(str(tmp_path / "fb.db"))
    agent.memory.save(
        MemoryRecord(id="1", content="c", tags=[], timestamp="t", kind=MemoryKind.NOTE)
    )
    resp = agent.respond([LLMMessage(role="user", content="fail me")])
    assert "–û—à–∏–±–∫–∞ –º–æ–¥–µ–ª–∏" in resp


def test_agent_plan_command_with_stub_planner(monkeypatch) -> None:
    agent = Agent(brain=SimpleBrain())
    stub = StubPlanner()
    agent.planner = stub  # type: ignore[assignment]
    result = agent.handle_tool_command("/plan goal")
    assert "step-one" in result
    assert stub.executed


def test_agent_set_mode_invalid() -> None:
    agent = Agent(brain=SimpleBrain())
    try:
        agent.set_mode("dual")
    except ValueError as exc:
        assert "–†–µ–∂–∏–º—ã" in str(exc)
    else:  # pragma: no cover - safety
        raise AssertionError("–î–æ–ª–∂–Ω–æ –±—ã–ª–æ –≤—ã–±—Ä–æ—Å–∏—Ç—å ValueError")


def test_save_feedback_major_hint(tmp_path: Path) -> None:
    agent = Agent(brain=SimpleBrain())
    agent.feedback = FeedbackManager(str(tmp_path / "fb.db"))
    agent.save_feedback("p", "a", "bad", hint=None)
    records = agent.feedback.get_recent_records(1)
    assert records and records[0]["severity"] == "major"
    assert records[0]["hint"]


def test_mode_config_invalid_file(tmp_path: Path) -> None:
    bad_path = tmp_path / "mode.json"
    bad_path.write_text("{notjson", encoding="utf-8")
    try:
        load_mode(bad_path)
    except RuntimeError:
        pass
    save_mode("single", bad_path)
    assert json.loads(bad_path.read_text())["mode"] == "single"



================================================================================
üìÅ –§–ê–ô–õ: tests/test_executor.py
üìä –†–∞–∑–º–µ—Ä: 1095 –±–∞–π—Ç (1KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_executor.py
================================================================================

from __future__ import annotations

from core.executor import Executor
from core.tool_gateway import ToolGateway
from shared.models import PlanStep, PlanStepStatus, TaskPlan, ToolRequest, ToolResult
from tools.tool_registry import ToolRegistry


def test_executor_with_tool_and_critic_rejects() -> None:
    registry = ToolRegistry()

    def echo_handler(_: ToolRequest) -> ToolResult:
        return ToolResult.success({"output": "ok"})

    registry.register("web", echo_handler, enabled=True)
    gateway = ToolGateway(registry)
    plan = TaskPlan(
        goal="test",
        steps=[
            PlanStep(description="web step", operation="web"),
            PlanStep(description="next"),
        ],
    )

    def critic(step: PlanStep) -> tuple[bool, str | None]:
        if "web" in step.description:
            return False, "no web"
        return True, None

    executor = Executor()
    executed = executor.run(plan, tool_gateway=gateway, critic_callback=critic)
    assert executed.steps[0].status == PlanStepStatus.ERROR
    assert "no web" in (executed.steps[0].result or "")



================================================================================
üìÅ –§–ê–ô–õ: tests/test_project_tool_index.py
üìä –†–∞–∑–º–µ—Ä: 1095 –±–∞–π—Ç (1KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_project_tool_index.py
================================================================================

from __future__ import annotations

from shared.models import ToolRequest
from tools.project_tool import handle_project_request


class DummyVectorIndex:
    def __init__(self, db_path: str = "memory/vectors.db"):  # noqa: ARG002
        self.indexed = []

    def index_text(self, path: str, content: str, namespace: str = "default", meta=None) -> None:
        self.indexed.append((path, namespace, content[:10]))

    def search(self, query: str, namespace: str = "default", top_k: int = 5):  # noqa: ARG002
        return []


def test_project_index_uses_vector_index(tmp_path, monkeypatch) -> None:
    base = tmp_path / "proj"
    base.mkdir()
    (base / "a.py").write_text("print('hi')", encoding="utf-8")
    (base / "readme.md").write_text("# doc", encoding="utf-8")

    monkeypatch.setattr("tools.project_tool.VectorIndex", DummyVectorIndex)

    req = ToolRequest(name="project", args={"cmd": "index", "args": [str(base)]})
    result = handle_project_request(req)
    assert result.ok
    assert result.data.get("indexed_code") == 1
    assert result.data.get("indexed_docs") == 1



================================================================================
üìÅ –§–ê–ô–õ: tests/test_tools.py
üìä –†–∞–∑–º–µ—Ä: 2436 –±–∞–π—Ç (2KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_tools.py
================================================================================

from __future__ import annotations

import uuid

from shared.models import ToolRequest
from tools.filesystem_tool import handle_filesystem
from tools.http_client import HttpResult
from tools.shell_tool import handle_shell
from tools.web_search_tool import WebSearchTool


def test_filesystem_write_and_read_roundtrip() -> None:
    filename = f"test_{uuid.uuid4().hex}.txt"
    content = "hello world"
    write_result = handle_filesystem(
        ToolRequest(name="write", args={"path": filename, "content": content})
    )
    assert write_result.ok, write_result.error

    read_result = handle_filesystem(ToolRequest(name="read", args={"path": filename}))
    assert read_result.ok, read_result.error
    assert read_result.data.get("output") == content


def test_filesystem_denies_escape() -> None:
    result = handle_filesystem(ToolRequest(name="read", args={"path": "../etc/passwd"}))
    assert not result.ok
    assert "–ø–µ—Å–æ—á–Ω–∏—Ü–µ" in (result.error or "").lower()


def test_shell_blocks_dangerous_command() -> None:
    result = handle_shell("rm -rf /")
    assert not result.ok


def test_shell_allows_simple_command() -> None:
    from tools.shell_tool import ShellConfig, handle_shell_request

    cfg = ShellConfig(allowed_commands=["echo"])
    result = handle_shell_request(
        ToolRequest(name="shell", args={"command": "echo hi", "shell_config": cfg.__dict__})
    )
    assert result.ok
    assert "hi" in str(result.data.get("output"))


def test_web_search_simulation() -> None:
    class DummyHttp:
        def get_text(self, url: str, **kwargs):
            return HttpResult(
                ok=True,
                data="stub content",
                status_code=200,
                error=None,
                headers={},
                meta={},
            )

    web = WebSearchTool(http_client=DummyHttp())
    result = web.handle(ToolRequest(name="web", args={"query": "https://example.com"}))
    assert result.ok
    assert "stub content" in str(result.data.get("output"))


def test_web_invalid_url() -> None:
    web = WebSearchTool()
    result = web.handle(ToolRequest(name="web", args={"query": "ftp://example.com"}))
    assert not result.ok


def test_shell_blocks_absolute_path() -> None:
    result = handle_shell("cat /etc/hosts")
    assert not result.ok


def test_shell_blocks_command_chaining() -> None:
    result = handle_shell("ls && whoami")
    assert not result.ok



================================================================================
üìÅ –§–ê–ô–õ: tests/test_agent_feedback_save.py
üìä –†–∞–∑–º–µ—Ä: 1104 –±–∞–π—Ç (1KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_agent_feedback_save.py
================================================================================

from __future__ import annotations

from memory.feedback_manager import FeedbackManager


def test_save_feedback_variants(tmp_path) -> None:
    from core.agent import Agent
    from llm.brain_base import Brain
    from llm.types import LLMResult, ModelConfig

    class BrainStub(Brain):
        def generate(self, messages, config: ModelConfig | None = None):  # type: ignore[override]
            return LLMResult(text="ok")

    agent = Agent(brain=BrainStub())
    agent.feedback = FeedbackManager(str(tmp_path / "fb.db"))

    agent.save_feedback("p", "a", "good", hint=None)
    agent.save_feedback("p2", "a2", "bad", hint="fix")
    agent.save_feedback("p3", "a3", "offtopic", hint=None)

    records = agent.feedback.get_recent_records(5)
    ratings = {r["rating"] for r in records}
    assert "good" in ratings and "bad" in ratings and "offtopic" in ratings
    majors = [r for r in records if r["severity"] in {"major", "fatal"}]
    assert majors, "major –∑–∞–ø–∏—Å–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å"
    hints = [r for r in records if r.get("hint")]
    assert any("fix" in r["hint"] for r in hints)



================================================================================
üìÅ –§–ê–ô–õ: tests/conftest.py
üìä –†–∞–∑–º–µ—Ä: 180 –±–∞–π—Ç (180B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/conftest.py
================================================================================

from __future__ import annotations

import sys
from pathlib import Path

ROOT = Path(__file__).resolve().parents[1]
if str(ROOT) not in sys.path:
    sys.path.insert(0, str(ROOT))



================================================================================
üìÅ –§–ê–ô–õ: tests/test_agent_modes_logic.py
üìä –†–∞–∑–º–µ—Ä: 3642 –±–∞–π—Ç (3KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_agent_modes_logic.py
================================================================================

from __future__ import annotations

from core.agent import Agent
from llm.brain_base import Brain
from llm.dual_brain import DualBrain
from llm.types import LLMResult, ModelConfig
from shared.models import LLMMessage, PlanStep, PlanStepStatus, TaskPlan


class CountingBrain(Brain):
    def __init__(self, text: str) -> None:
        self.text = text
        self.calls = 0

    def generate(
        self, messages: list[LLMMessage], config: ModelConfig | None = None
    ) -> LLMResult:
        self.calls += 1
        return LLMResult(text=self.text)


class StubPlanner:
    def __init__(self) -> None:
        self._parse = None

    def classify_complexity(self, goal: str):  # noqa: ANN001
        from shared.models import TaskComplexity

        return TaskComplexity.COMPLEX

    def build_plan(self, goal: str, brain=None, model_config=None) -> TaskPlan:  # noqa: ANN001
        return TaskPlan(
            goal=goal, steps=[PlanStep(description="orig1"), PlanStep(description="orig2")]
        )

    def _parse_plan_text(self, text: str):
        from core.planner import Planner

        return Planner()._parse_plan_text(text)  # noqa: SLF001


class FakeExecutor:
    def __init__(self) -> None:
        self.run_called = False
        self.received_plan: TaskPlan | None = None

    def run(self, plan: TaskPlan, tool_gateway=None, critic_callback=None) -> TaskPlan:  # noqa: ANN001
        self.run_called = True
        self.received_plan = plan
        for step in plan.steps:
            step.status = PlanStepStatus.DONE
            step.result = "ok"
        return plan


def _prepare_agent(mode: str) -> tuple[Agent, FakeExecutor, CountingBrain, CountingBrain | None]:
    main = CountingBrain("main")
    critic = CountingBrain("1. rewritten\n2. done") if mode != "single" else None
    brain = DualBrain(main, critic) if critic else main
    if isinstance(brain, DualBrain):
        brain.set_mode(mode)
    agent = Agent(brain=brain)
    agent.planner = StubPlanner()  # type: ignore[assignment]
    executor = FakeExecutor()
    agent.executor = executor  # type: ignore[assignment]
    agent.memory.get_recent = lambda *a, **k: []  # type: ignore[attr-defined]
    agent.memory.get_user_prefs = lambda: []  # type: ignore[attr-defined]
    agent.vectors.search = lambda *a, **k: []  # type: ignore[attr-defined]
    agent.feedback.get_recent_hints_meta = lambda *a, **k: []  # type: ignore[attr-defined]
    return agent, executor, main, critic


def test_agent_single_executes_plan() -> None:
    agent, executor, main, critic = _prepare_agent("single")
    resp = agent.respond([LLMMessage(role="user", content="–ø–ª–∞–Ω –∑–∞–¥–∞—á–∏")])
    assert "orig1" in resp
    assert agent.last_plan and all(
        step.status == PlanStepStatus.DONE for step in agent.last_plan.steps
    )
    assert critic is None
    assert critic is None


def test_agent_dual_uses_critic_plan() -> None:
    agent, executor, main, critic = _prepare_agent("dual")
    agent.respond([LLMMessage(role="user", content="–ø–ª–∞–Ω –∑–∞–¥–∞—á–∏")])
    assert agent.last_plan
    assert agent.last_plan and agent.last_plan.steps[0].description.startswith("rewritten")
    assert critic and critic.calls >= 1


def test_agent_critic_only_not_execute_tools() -> None:
    agent, executor, main, critic = _prepare_agent("critic-only")
    resp = agent.respond([LLMMessage(role="user", content="–ø–ª–∞–Ω –∑–∞–¥–∞—á–∏")])
    assert not executor.run_called
    assert "rewritten" in resp or "done" in resp
    assert critic and critic.calls >= 1
    assert main.calls == 0  # main –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ critic-only –ø—Ä–∏ –ø–ª–∞–Ω–µ



================================================================================
üìÅ –§–ê–ô–õ: tests/test_http_client_bytes.py
üìä –†–∞–∑–º–µ—Ä: 882 –±–∞–π—Ç (882B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_http_client_bytes.py
================================================================================

from __future__ import annotations

from tools.http_client import HttpClient, HttpConfig


class DummyResponse:
    def __init__(self, body: bytes, status_code: int = 200) -> None:
        self.body = body
        self.status_code = status_code
        self.headers = {}

    def raise_for_status(self) -> None:
        return

    def iter_content(self, chunk_size: int = 4096, decode_unicode: bool = False):
        yield self.body


def test_http_client_reads_bytes(monkeypatch) -> None:
    client = HttpClient(HttpConfig(max_bytes=20))

    def fake_request(**kwargs):
        return DummyResponse(b"0123456789", status_code=200)

    monkeypatch.setattr(
        "tools.http_client.requests.request", lambda **kwargs: fake_request(**kwargs)
    )
    result = client.post_bytes("http://example.com")
    assert result.ok
    assert isinstance(result.data, (bytes, bytearray))



================================================================================
üìÅ –§–ê–ô–õ: tests/test_llm_clients.py
üìä –†–∞–∑–º–µ—Ä: 2570 –±–∞–π—Ç (2KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_llm_clients.py
================================================================================

from __future__ import annotations

from typing import Any

import pytest

from llm.local_http_brain import LocalHttpBrain
from llm.openrouter_brain import OpenRouterBrain
from llm.types import ModelConfig
from shared.models import LLMMessage


def _mock_response(payload: dict[str, Any]):
    class Response:
        status_code = 200

        def json(self) -> dict[str, Any]:
            return payload

        def raise_for_status(self) -> None:
            return None

    return Response()


def test_openrouter_generate(monkeypatch) -> None:
    calls: dict[str, Any] = {}

    def fake_post(url, json, headers, timeout):
        calls["url"] = url
        calls["json"] = json
        calls["headers"] = headers
        return _mock_response(
            {
                "choices": [{"message": {"content": "hi"}}],
                "usage": {"prompt_tokens": 1, "completion_tokens": 1, "total_tokens": 2},
            }
        )

    monkeypatch.setattr("llm.openrouter_brain.requests.post", fake_post)
    config = ModelConfig(provider="openrouter", model="test-model", temperature=0.1)
    brain = OpenRouterBrain(api_key="test-key", default_config=config)

    result = brain.generate([LLMMessage(role="user", content="ping")])
    assert result.text == "hi"
    assert calls["url"] == "https://openrouter.ai/api/v1/chat/completions"
    assert calls["headers"]["Authorization"] == "Bearer test-key"
    assert calls["json"]["model"] == "test-model"


def test_local_http_generate(monkeypatch) -> None:
    calls: dict[str, Any] = {}

    def fake_post(url, json, headers, timeout):
        calls["url"] = url
        calls["json"] = json
        return _mock_response({"choices": [{"message": {"content": "pong"}}]})

    monkeypatch.setattr("llm.local_http_brain.requests.post", fake_post)
    config = ModelConfig(provider="local", model="local-model", temperature=0.2, base_url="http://localhost:9999/v1/chat/completions")
    brain = LocalHttpBrain(default_config=config)

    result = brain.generate([LLMMessage(role="user", content="hello")])
    assert result.text == "pong"
    assert calls["url"] == "http://localhost:9999/v1/chat/completions"
    assert calls["json"]["model"] == "local-model"


def test_openrouter_without_key_raises(monkeypatch) -> None:
    monkeypatch.setenv("OPENROUTER_API_KEY", "")
    config = ModelConfig(provider="openrouter", model="test-model")
    brain = OpenRouterBrain(api_key=None, default_config=config)
    with pytest.raises(RuntimeError):
        brain.generate([LLMMessage(role="user", content="ping")])



================================================================================
üìÅ –§–ê–ô–õ: tests/test_tool_registry.py
üìä –†–∞–∑–º–µ—Ä: 1294 –±–∞–π—Ç (1KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_tool_registry.py
================================================================================

from __future__ import annotations

from shared.models import ToolRequest, ToolResult
from tools.tool_logger import ToolCallLogger
from tools.tool_registry import ToolRegistry


def test_tool_registry_logs_success(tmp_path) -> None:
    log_path = tmp_path / "tool_calls.log"
    registry = ToolRegistry(call_logger=ToolCallLogger(log_path))

    def handler(_: ToolRequest) -> ToolResult:
        return ToolResult.success({"output": "ok"})

    registry.register("dummy", handler, enabled=True)
    result = registry.call(ToolRequest(name="dummy", args={"k": "v"}))
    assert result.ok

    records = registry.read_recent_calls()
    assert len(records) == 1
    assert records[0].tool == "dummy"
    assert records[0].ok
    assert records[0].args == {"k": "v"}


def test_tool_registry_logs_disabled(tmp_path) -> None:
    log_path = tmp_path / "tool_calls.log"
    registry = ToolRegistry(call_logger=ToolCallLogger(log_path))

    def handler(_: ToolRequest) -> ToolResult:
        return ToolResult.success({})

    registry.register("dummy", handler, enabled=False)
    result = registry.call(ToolRequest(name="dummy"))
    assert not result.ok

    records = registry.read_recent_calls()
    assert len(records) == 1
    assert records[0].tool == "dummy"
    assert not records[0].ok



================================================================================
üìÅ –§–ê–ô–õ: tests/test_planner.py
üìä –†–∞–∑–º–µ—Ä: 1522 –±–∞–π—Ç (1KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_planner.py
================================================================================

from __future__ import annotations

from core.planner import MAX_STEPS, MIN_STEPS, Planner
from llm.types import LLMResult


class FakeBrain:
    def __init__(self, text: str) -> None:
        self._text = text

    def generate(self, messages, config=None):  # type: ignore[override]
        return LLMResult(text=self._text)


def test_classify_simple_vs_complex() -> None:
    planner = Planner()
    assert planner.classify_complexity("–ü—Ä–∏–≤–µ—Ç, –ø–æ–º–æ–≥–∏").value == "simple"
    assert (
        planner.classify_complexity("–ù–∞–π–¥–∏ –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞").value
        == "complex"
    )


def test_plan_parsing_validation_limits() -> None:
    planner = Planner()
    steps_text = "\n".join([f"{i+1}. step {i+1}" for i in range(MIN_STEPS + 1)])
    brain = FakeBrain(steps_text)
    parsed = planner._llm_plan("goal", brain, None)  # type: ignore[arg-type]
    assert parsed is not None
    assert MIN_STEPS <= len(parsed) <= MAX_STEPS

    too_many = "\n".join([f"{i+1}. step {i+1}" for i in range(MAX_STEPS + 5)])
    brain_many = FakeBrain(too_many)
    assert planner._llm_plan("goal", brain_many, None) is None  # type: ignore[arg-type]


def test_build_plan_fallback_on_invalid_llm_plan() -> None:
    planner = Planner()
    invalid_brain = FakeBrain("1. one\n")  # –≤—Å–µ–≥–æ –æ–¥–∏–Ω —à–∞–≥ => –±—É–¥–µ—Ç –æ—Ç–±—Ä–æ—à–µ–Ω–æ
    plan = planner.build_plan("goal", brain=invalid_brain)  # type: ignore[arg-type]
    assert len(plan.steps) >= MIN_STEPS



================================================================================
üìÅ –§–ê–ô–õ: tests/test_http_client_truncate.py
üìä –†–∞–∑–º–µ—Ä: 1027 –±–∞–π—Ç (1KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_http_client_truncate.py
================================================================================

from __future__ import annotations

from tools.http_client import HttpClient, HttpConfig


class DummyResponse:
    def __init__(self, body: bytes, status_code: int = 200) -> None:
        self.body = body
        self.status_code = status_code
        self.headers: dict[str, str] = {}

    def raise_for_status(self) -> None:
        return

    def iter_content(self, chunk_size: int = 4096, decode_unicode: bool = False):  # noqa: ARG002
        yield self.body


def test_http_client_payload_too_large(monkeypatch) -> None:
    client = HttpClient(HttpConfig(max_bytes=5, max_json_bytes=5))

    def fake_request(method: str, url: str, timeout: int, stream: bool, **kwargs):  # noqa: ANN001
        return DummyResponse(b"{\"a\": 123456}", status_code=200)

    monkeypatch.setattr("tools.http_client.requests.request", fake_request)
    result = client.post_json("http://example.com")
    assert not result.ok
    assert result.error == "payload_too_large"
    assert result.meta and result.meta.get("truncated") is True



================================================================================
üìÅ –§–ê–ô–õ: tests/test_safe_mode.py
üìä –†–∞–∑–º–µ—Ä: 807 –±–∞–π—Ç (807B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_safe_mode.py
================================================================================

from __future__ import annotations

from shared.models import ToolRequest, ToolResult
from tools.tool_registry import ToolRegistry


def test_safe_mode_blocks_web_shell() -> None:
    registry = ToolRegistry(safe_block={"web", "shell"})

    def ok_handler(_: ToolRequest) -> ToolResult:
        return ToolResult.success({"output": "ok"})

    registry.register("web", ok_handler, enabled=True)
    registry.register("shell", ok_handler, enabled=True)
    registry.apply_safe_mode(True)

    res_web = registry.call(ToolRequest(name="web"))
    assert not res_web.ok
    assert "safe mode" in (res_web.error or "").lower() or "–æ—Ç–∫–ª—é—á—ë–Ω" in (
        res_web.error or ""
    ).lower()

    registry.apply_safe_mode(False)
    res_web2 = registry.call(ToolRequest(name="web"))
    assert res_web2.ok



================================================================================
üìÅ –§–ê–ô–õ: tests/test_feedback_meta.py
üìä –†–∞–∑–º–µ—Ä: 586 –±–∞–π—Ç (586B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_feedback_meta.py
================================================================================

from __future__ import annotations

import os
from tempfile import NamedTemporaryFile

from memory.feedback_manager import FeedbackManager


def test_feedback_hints_meta() -> None:
    with NamedTemporaryFile(delete=False) as tmp:
        path = tmp.name
    try:
        mgr = FeedbackManager(path)
        mgr.save_feedback("p", "a", "bad", severity="major", hint="fix it")
        hints = mgr.get_recent_hints_meta(1, severity_filter=["major"])
        assert hints and hints[0]["hint"] == "fix it"
        assert hints[0]["severity"] == "major"
    finally:
        os.remove(path)



================================================================================
üìÅ –§–ê–ô–õ: tests/test_memory.py
üìä –†–∞–∑–º–µ—Ä: 1480 –±–∞–π—Ç (1KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_memory.py
================================================================================

from __future__ import annotations

from memory.memory_manager import MemoryManager
from shared.models import MemoryKind, MemoryRecord, ProjectFact, UserPreference


def test_memory_save_and_search(tmp_path) -> None:
    db_path = tmp_path / "mem.db"
    manager = MemoryManager(str(db_path))
    item = MemoryRecord(
        id="1",
        content="hello memory world",
        tags=["test"],
        timestamp="2024-01-01",
        kind=MemoryKind.NOTE,
        meta={"source": "test"},
    )
    manager.save(item)

    results = manager.search("memory", kind=MemoryKind.NOTE)
    assert len(results) == 1
    assert results[0].content == item.content
    assert results[0].tags == item.tags


def test_user_pref_and_project_fact(tmp_path) -> None:
    db_path = tmp_path / "mem.db"
    manager = MemoryManager(str(db_path))

    pref = UserPreference(
        id="pref1",
        key="theme",
        value="dark",
        timestamp="2024-01-01",
        tags=["ui"],
    )
    fact = ProjectFact(
        id="fact1",
        project="projA",
        content="Uses FastAPI",
        timestamp="2024-01-02",
        tags=["stack"],
        meta={"author": "dev"},
    )

    manager.save_user_pref(pref)
    manager.save_project_fact(fact)

    prefs = manager.get_user_prefs("theme")
    assert len(prefs) == 1
    assert prefs[0].meta.get("value") == "dark"

    facts = manager.get_project_facts("projA")
    assert len(facts) == 1
    assert "FastAPI" in facts[0].content



================================================================================
üìÅ –§–ê–ô–õ: tests/test_settings_dataclass.py
üìä –†–∞–∑–º–µ—Ä: 475 –±–∞–π—Ç (475B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_settings_dataclass.py
================================================================================

from __future__ import annotations

from config.settings import AppSettings
from llm.types import ModelConfig


def test_app_settings_defaults() -> None:
    main = ModelConfig(
        provider="openrouter",
        model="gpt-test",
        temperature=0.1,
        max_tokens=100,
    )
    settings = AppSettings(main_config=main)
    assert settings.main_config.model == "gpt-test"
    assert settings.shell_timeout_seconds == 10
    assert settings.tools_enabled == {}



================================================================================
üìÅ –§–ê–ô–õ: tests/test_image_tools.py
üìä –†–∞–∑–º–µ—Ä: 1363 –±–∞–π—Ç (1KB)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_image_tools.py
================================================================================

from __future__ import annotations

import base64
from io import BytesIO

from PIL import Image

from shared.models import ToolRequest
from tools.image_analyze_tool import ImageAnalyzeTool
from tools.image_generate_tool import ImageGenerateTool


def test_image_generate_returns_base64() -> None:
    req = ToolRequest(
        name="img_gen",
        args={"prompt": "square", "width": 64, "height": 64, "color": "#112233"},
    )
    result = ImageGenerateTool().handle(req)
    assert result.ok
    b64 = result.data.get("base64")
    assert isinstance(b64, str) and len(b64) > 10
    meta = result.meta or {}
    assert meta.get("width") == 64
    assert meta.get("height") == 64


def test_image_analyze_handles_invalid_input() -> None:
    req = ToolRequest(name="img_analyze", args={"base64": "not_base64"})
    result = ImageAnalyzeTool().handle(req)
    assert not result.ok


def test_image_analyze_valid_base64(monkeypatch) -> None:
    # generate small valid image
    img = Image.new("RGB", (8, 8), color="#ff00ff")
    buf = BytesIO()
    img.save(buf, format="PNG")
    data_b64 = base64.b64encode(buf.getvalue()).decode("utf-8")

    req = ToolRequest(name="img_analyze", args={"base64": data_b64})
    result = ImageAnalyzeTool().handle(req)
    assert result.ok
    assert result.data.get("width") == 8
    assert result.data.get("height") == 8



================================================================================
üìÅ –§–ê–ô–õ: tests/test_shell_tool_apply_config.py
üìä –†–∞–∑–º–µ—Ä: 567 –±–∞–π—Ç (567B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_shell_tool_apply_config.py
================================================================================

from __future__ import annotations

from shared.models import ToolRequest
from tools.shell_tool import handle_shell_request


def test_shell_tool_applies_config(tmp_path) -> None:
    req = ToolRequest(
        name="shell",
        args={
            "command": "echo hi",
            "shell_config": {
                "allowed_commands": ["echo"],
                "timeout_seconds": 1,
                "max_output_chars": 10,
                "sandbox_root": str(tmp_path),
            },
        },
    )
    result = handle_shell_request(req)
    assert result.ok



================================================================================
üìÅ –§–ê–ô–õ: tests/test_plan_critic.py
üìä –†–∞–∑–º–µ—Ä: 800 –±–∞–π—Ç (800B)
üìÇ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: /home/k/project/Slavik/slavikai/tests/test_plan_critic.py
================================================================================

from __future__ import annotations

from core.agent import Agent
from llm.dual_brain import DualBrain
from llm.types import LLMResult
from shared.models import PlanStep, TaskPlan


class DummyBrain:
    def __init__(self, text: str) -> None:
        self._text = text

    def generate(self, messages, config=None):  # noqa: ANN001
        return LLMResult(text=self._text)


def test_plan_critic_rewrites_plan() -> None:
    main = DummyBrain("unused")
    critic = DummyBrain("1. new step\n2. finish")
    dual = DualBrain(main, critic)
    agent = Agent(brain=dual, critic=None)
    plan = TaskPlan(goal="goal", steps=[PlanStep(description="old")])

    improved = agent._critic_plan(plan)  # noqa: SLF001
    assert len(improved.steps) == 2
    assert "new step" in improved.steps[0].description



