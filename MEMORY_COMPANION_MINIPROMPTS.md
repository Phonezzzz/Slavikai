# MEMORY_COMPANION_MINIPROMPTS ‚Äî –ø–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è Memory Companion (Policies‚Äëfirst, BatchReview‚Äëfirst)

–≠—Ç–æ—Ç –ø–ª–∞–Ω –ø–µ—Ä–µ–ø–∏—Å–∞–Ω —Ç–∞–∫, —á—Ç–æ–±—ã –æ—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –±—ã–ª **BatchReview –ø–æ –∫–Ω–æ–ø–∫–µ** (‚Äú–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö‚Äù) —Å **Approve / Edit / Reject**, –∞ unified pipeline –∏ –∞—É–¥–∏—Ç‚Äë–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏.

## –ë–∞–∑–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã, –∫–∞–∫ –≤ –ø—Ä–æ–µ–∫—Ç–µ —Å–µ–π—á–∞—Å)

- Python 3.12, `ruff` lint/format (—Å–º. `pyproject.toml`).
- `mypy` strict (—Å–º. `pyproject.toml`), **–±–µ–∑ `Any` –∏ –±–µ–∑ ‚Äú–∫–∞—Å—Ç–æ–≤‚Äù –≤ –¥–æ–º–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–µ**.
- No silent-fallback: –ª—é–±–æ–π fallback –ª–∏–±–æ —è–≤–Ω—ã–π –∏ —Ç—Ä–∞—Å—Å–∏—Ä—É–µ–º—ã–π, –ª–∏–±–æ –æ—à–∏–±–∫–∞.
- –í—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `ToolResult` (—Å–º. `shared/models.py`, `tools/protocols.py`).
- Sandbox/safe-mode –Ω–µ –æ–±—Ö–æ–¥–∏—Ç—å (—Å–º. `core/agent.py`, `tools/*`).
- –¢–µ—Å—Ç—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã: `pytest` + `pytest-cov`, coverage –Ω–µ –Ω–∏–∂–µ `80%` (—Å–º. `pyproject.toml`).

## –¶–µ–ª–µ–≤–∞—è –º–æ–¥–µ–ª—å —Å–∏—Å—Ç–µ–º—ã (—Ñ–∏–∫—Å–∏—Ä—É–µ–º)

1) **Memory Companion = Policies-first**, –∞ –Ω–µ ‚Äúlearning_rate / sentiment-driven‚Äù.
2) –¢–µ—Ä–º–∏–Ω—ã:
- **Memory** = —Ñ–∞–∫—Ç—ã/–∫–æ–Ω—Ç–µ–∫—Å—Ç (–¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å —è–≤–Ω—ã–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º).
- **Feedback** = —è–≤–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ (üëç üòê üëé + labels + optional free_text).
- **Policies** = –ø—Ä–∞–≤–∏–ª–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è (trigger/action), –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.
3) **–ó–∞–ø—Ä–µ—Ç –∞–≤—Ç–æ-–∏–∑–º–µ–Ω–µ–Ω–∏–π**:
- –ù–∏–∫–∞–∫–∏—Ö –∞–≤—Ç–æ-–∞–ø–¥–µ–π—Ç–æ–≤ –ø–∞–º—è—Ç–∏.
- –ù–∏–∫–∞–∫–∏—Ö –∞–≤—Ç–æ-—Å–æ–∑–¥–∞–Ω–∏–π/–∏–∑–º–µ–Ω–µ–Ω–∏–π `PolicyRule`.
- –ü—Ä–∞–≤–∏–ª–∞ –ø–æ—è–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–∞–∫ **Approved** –ø–æ—Å–ª–µ —Ä—É—á–Ω–æ–≥–æ review.
4) ‚Äú–ú–æ–ª—á–∞–Ω–∏–µ‚Äù:
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ñ–∏–¥–±—ç–∫–∞ –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ = `unknown`, **–Ω–µ** `good`.

## Intent/Paradox —Å–ª–æ–π (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –Ω–µ ‚Äú–≤–µ—Ä–¥–∏–∫—Ç‚Äù)

IntentAnalysis / ParadoxDetection ‚Äî –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å–ª–æ–π –∞–Ω–∞–ª–∏–∑–∞, –∫–æ—Ç–æ—Ä—ã–π:
- –§–æ—Ä–º–∏—Ä—É–µ—Ç **–Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–∏–ø–æ—Ç–µ–∑** intent‚Äô–∞ —Å–æ score (–Ω–µ ‚Äú–æ–¥–Ω–∞ –∏—Å—Ç–∏–Ω–∞‚Äù).
- –í—ã—Å—Ç–∞–≤–ª—è–µ—Ç flags –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π (paradox/contradiction): ‚Äú—Ñ–æ—Ä–º–∞ vs —Å–º—ã—Å–ª‚Äù, —Å–∞–º–æ—Å—Å—ã–ª–∫–∏, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á—Ç–æ–±—ã:
  - –ø–æ–Ω–∏–∂–∞—Ç—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤—ã–≤–æ–¥–æ–≤,
  - –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–π,
  - —É–ª—É—á—à–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ **–∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤** –ø—Ä–∞–≤–∏–ª (PolicyRuleCandidate).

–Ø–≤–Ω—ã–µ –∑–∞–ø—Ä–µ—Ç—ã (–≤ —Ç–µ–∫—Å—Ç–µ –ø–ª–∞–Ω–∞, —á—Ç–æ–±—ã Codex –Ω–µ ‚Äú–æ–±—É—á–∞–ª—Å—è –Ω–µ —Ç—É–¥–∞‚Äù):
- ‚Äú—Å–∞—Ä–∫–∞–∑–º = –ø–ª–æ—Ö–æ‚Äù ‚Äî –∑–∞–ø—Ä–µ—â–µ–Ω–æ.
- ‚Äú–º–∞—Ç = –ø–ª–æ—Ö–æ‚Äù ‚Äî –∑–∞–ø—Ä–µ—â–µ–Ω–æ (—ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å—Ç–∏–ª—å‚Äë—Å–∏–≥–Ω–∞–ª, –Ω–µ –≤–µ—Ä–¥–∏–∫—Ç).
- ‚Äú–º–æ–ª—á–∞–Ω–∏–µ = —Ö–æ—Ä–æ—à–æ‚Äù ‚Äî –∑–∞–ø—Ä–µ—â–µ–Ω–æ.

## Unified pipeline (–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω) + CommandLane (MC‚ÄëQ3 —Ñ–∏–∫—Å–∏—Ä—É–µ–º)

- –õ—é–±–æ–π –≤—Ö–æ–¥, –≤–ª–∏—è—é—â–∏–π –Ω–∞ tools/LLM/–¥–∞–Ω–Ω—ã–µ, –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ **unified pipeline entrypoint**.
- `/fs /web /sh /project` –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ pipeline –∫–∞–∫ **CommandLane** –∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ `InteractionLog` —Å `interaction_kind="tool"`.
- –í–Ω—É—Ç—Ä–∏ CommandLane: parse ‚Üí validate/sandbox/safe-mode ‚Üí execute tool ‚Üí format result ‚Üí log.
- –û—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ ‚Äú–∫–æ–º–∞–Ω–¥–Ω–æ–≥–æ –ø—É—Ç–∏‚Äù –±—ã—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–æ: —Å–Ω–∞—Ä—É–∂–∏ pipeline –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–æ–Ω–∫–∏–π –ø–∞—Ä—Å–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ—à–∞–µ—Ç –∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Ö–æ–¥.
- –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: —á–∏—Å—Ç–æ UI‚Äë–ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫/–ø–∞–Ω–µ–ª–µ–π), –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—â–∏–µ tools/LLM/–¥–∞–Ω–Ω—ã–µ.

## Storage (MC‚ÄëQ2 —Ñ–∏–∫—Å–∏—Ä—É–µ–º)

- –ü–µ—Ä–≤–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è: –æ—Ç–¥–µ–ª—å–Ω–∞—è SQLite –ë–î `memory/memory_companion.db`.
- –ù–∏–∫–∞–∫–∏—Ö —Ä–∞–Ω–Ω–∏—Ö –º–∏–≥—Ä–∞—Ü–∏–π legacy –ë–î (`memory/memory.db`, `memory/feedback.db`) ‚Äî –∏—Ö **–Ω–µ —Ç—Ä–æ–≥–∞–µ–º**.
- –í–º–µ—Å—Ç–æ ‚Äú—Å–ª–æ–∂–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π‚Äù: schema versioning + fail-fast –ø—Ä–∏ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (–±–µ–∑ silent-fallback).

## user_id (MC‚ÄëQ1 —Ñ–∏–∫—Å–∏—Ä—É–µ–º)

- –°–µ–π—á–∞—Å –ø—Ä–æ–µ–∫—Ç single-user, –Ω–æ –≤–µ–∑–¥–µ –¥–µ—Ä–∂–∏–º –ø–æ–ª–µ `user_id` –∏ –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º –µ–≥–æ —á–µ—Ä–µ–∑ pipeline.
- –ù–∞ —Å—Ç–∞—Ä—Ç–µ –¥–æ–ø—É—Å—Ç–∏–º `user_id="local"`.
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –ø–æ–∑–∂–µ: `user_id = sha256(machine_salt + "local")` (–µ—Å–ª–∏ –≤–≤–æ–¥–∏—Ç—Å—è ‚Äî —è–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, –±–µ–∑ silent-fallback).

---

## –°—É—â–Ω–æ—Å—Ç–∏ (–º–∏–Ω–∏–º—É–º, policies-first + batch review)

### InteractionLog (–µ–¥–∏–Ω—ã–π –∞—É–¥–∏—Ç‚Äë—Ç—Ä–µ–∫)

–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø–æ–ª—è:
- `interaction_id` (uuid)
- `user_id`
- `interaction_kind` (`chat` | `tool`)
- `raw_input`
- `mode` (`standard` | `memory_companion`)
- `created_at`

–î–ª—è `interaction_kind="chat"` –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
- `retrieved_memory_ids[]` (–º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏)
- `applied_policy_ids[]` (—Ç–æ–ª—å–∫–æ Approved –ø—Ä–∞–≤–∏–ª–∞)
- `response_text`

–î–ª—è `interaction_kind="tool"` –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
- `tool_name`
- `tool_args` (—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ)
- `tool_status` (`ok` | `error` | `blocked`)
- `blocked_reason` (enum, –µ—Å–ª–∏ `blocked`)
- `tool_output_preview` / `tool_error` / `tool_meta`

`blocked_reason` (–ø—Ä–∏–º–µ—Ä enum):
- `safe_mode_blocked`
- `sandbox_violation`
- `tool_disabled`
- `tool_not_registered`
- `validation_error`

### FeedbackEvent (—Ç–æ–ª—å–∫–æ —è–≤–Ω—ã–π)

- `feedback_id` (uuid)
- `interaction_id` (fk)
- `user_id`
- `rating` (`good` | `ok` | `bad`)
- `labels[]` (—Å–º. Signals –Ω–∏–∂–µ)
- `free_text` (optional)
- `created_at`

–ï—Å–ª–∏ —Ñ–∏–¥–±—ç–∫–∞ –Ω–µ—Ç ‚Üí **–Ω–µ—Ç –∑–∞–ø–∏—Å–∏** (—ç—Ç–æ `unknown`).

### PolicyRule (—Ç–æ–ª—å–∫–æ Approved)

- `rule_id` (uuid)
- `user_id` (scope user/global)
- `scope` (`global` | `user`)
- `trigger` (typed)
- `action` (typed)
- `priority` (int)
- `confidence` (0..1)
- `decay_half_life_days` (int)
- `provenance` (–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω: `feedback_id` –∏–ª–∏ `batch_review_run_id`)
- `created_at`, `updated_at`

### PolicyRuleCandidate (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –Ω–µ –ø—Ä–∞–≤–∏–ª–æ)

- `candidate_id` (uuid)
- `batch_review_run_id` (fk)
- `user_id`
- `proposed_trigger` (typed)
- `proposed_action` (typed)
- `priority_suggestion`
- `confidence_suggestion`
- `evidence[]` (—Å–ø–∏—Å–æ–∫ interaction_id + –∫–æ—Ä–æ—Ç–∫–∏–µ –≤—ã–¥–µ—Ä–∂–∫–∏)
- `signals[]`
- `status` (`proposed` | `approved` | `rejected`)

---

## Signals (–Ω–µ –≤–µ—Ä–¥–∏–∫—Ç—ã)

BatchReview –∏—â–µ—Ç —Å–∏–≥–Ω–∞–ª—ã/–ª–µ–π–±–ª—ã –∏ —Å–æ–±–∏—Ä–∞–µ—Ç evidence. –ü—Ä–∏–º–µ—Ä—ã:
- `direct_negative_feedback` (—è–≤–Ω–∞—è –ø—Ä–µ—Ç–µ–Ω–∑–∏—è –≤ feedback labels/free_text)
- `explicit_positive` (—è–≤–Ω–æ good + ‚Äú—ç—Ç–æ –±—ã–ª–æ –ø–æ–ª–µ–∑–Ω–æ‚Äù)
- `style_profanity_only` (–º–∞—Ç/—Å–∞—Ä–∫–∞–∑–º –±–µ–∑ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω–æ–π –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏)
- `topic_switch` (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–∑–∫–æ —Å–º–µ–Ω–∏–ª —Ç–µ–º—É)
- `correction_by_user` (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∞–∫—Ç/–¥–µ—Ç–∞–ª—å)
- `silence_after_answer` ‚Üí `unknown` (–Ω–µ good/bad)

–ò–∑ signals —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è **–∫–∞–Ω–¥–∏–¥–∞—Ç—ã** –ø—Ä–∞–≤–∏–ª, –Ω–æ –Ω–µ –ø—Ä–∞–≤–∏–ª–∞.

---

# –≠—Ç–∞–ø—ã (–º–∏–Ω–∏‚Äë–ø—Ä–æ–º–ø—Ç—ã)

## MC0 ‚Äî Definitions (Intent/Paradox, Policies vs Memory, –∑–∞–ø—Ä–µ—Ç—ã)

### MC0.1 ‚Äî –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã ‚Äúno auto changes‚Äù
**–¶–µ–ª—å:** Codex –Ω–µ –¥–æ–ª–∂–µ–Ω –≤–Ω–µ–¥—Ä—è—Ç—å online‚Äë—Å–∞–º–æ–æ–±—É—á–µ–Ω–∏–µ.
**–§–∞–π–ª—ã:** `MEMORY_COMPANION_MINIPROMPTS.md`, `DevRules.md` (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª).
**–î–µ–π—Å—Ç–≤–∏—è:**
- –ü—Ä–æ–ø–∏—Å–∞—Ç—å –∑–∞–ø—Ä–µ—Ç—ã: –Ω–∏–∫–∞–∫–∏—Ö –∞–≤—Ç–æ‚Äë–∞–ø–¥–µ–π—Ç–æ–≤ Memory/Policies –±–µ–∑ approve.
- –ü—Ä–æ–ø–∏—Å–∞—Ç—å semantics: –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ñ–∏–¥–±—ç–∫–∞ = `unknown`.
**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- –í –ø–ª–∞–Ω–µ —è–≤–Ω–æ –∑–∞–ø—Ä–µ—â–µ–Ω—ã –∞–≤—Ç–æ‚Äë–∏–∑–º–µ–Ω–µ–Ω–∏—è, –∏ —ç—Ç–æ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤ —ç—Ç–∞–ø–∞—Ö MC4‚ÄìMC6.

### MC0.2 ‚Äî –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ Trigger/Action (–±–µ–∑ ‚Äúdict –Ω–∞ –≤—Å—ë‚Äù)
**–¶–µ–ª—å:** –±—É–¥—É—â–∏–µ `PolicyRule` –Ω–µ –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ –Ω–µ–≤–∞–ª–∏–¥–∏—Ä—É–µ–º—ã–π JSON.
**–î–µ–π—Å—Ç–≤–∏—è:**
- –û–ø–∏—Å–∞—Ç—å –¥–æ–ø—É—Å—Ç–∏–º—ã–µ trigger/action –∫–∞–∫ typed —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (—Å—Ç—Ä–æ–≥–æ).
**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- –í –ø–ª–∞–Ω–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω—ã –ø–æ–ª—è trigger/action –∏ –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏.

#### Policy Trigger/Action v1 (—Ñ–∏–∫—Å–∏—Ä—É–µ–º)

–ö–æ–¥–æ–≤–∞—è —Ç–æ—á–∫–∞ –¥–ª—è —Ç–∏–ø–æ–≤ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è): `shared/policy_models.py`.

**Trigger (typed)** ‚Äî –æ–¥–∏–Ω –∏–∑:
- `always` ‚Äî –±–µ–∑ –ø–æ–ª–µ–π (–ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞).
- `user_message_contains`:
  - `substrings: list[str]` (–Ω–µ–ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫),
  - `case_sensitive: bool` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `False`).
- `user_message_regex`:
  - `pattern: str` (–Ω–µ–ø—É—Å—Ç–∞—è regex-—Å—Ç—Ä–æ–∫–∞),
  - `case_insensitive: bool` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `True`).

**Action (typed)** ‚Äî –æ–¥–∏–Ω –∏–∑:
- `add_instruction`:
  - `text: str` (–Ω–µ –∫–æ—Ä–æ—á–µ 3 —Å–∏–º–≤–æ–ª–æ–≤).
- `set_response_style`:
  - `verbosity: "concise" | "normal" | "detailed"` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `"normal"`).

#### –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è PolicyRule (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ)

–ü—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–∞–≤–∏–ª –ø–æ—Ä—è–¥–æ–∫ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ:
1) `priority` (desc)
2) `scope`: `user` –≤—ã—à–µ `global`
3) `confidence` (desc)
4) `updated_at` (desc)
5) `rule_id` (lexicographic asc) ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω—ã–π tie-breaker

---

## MC1 ‚Äî InteractionLog (–µ–¥–∏–Ω—ã–π), –≤–∫–ª—é—á–∞—è tool‚Äë–≤–µ—Ç–∫—É

### MC1.1 ‚Äî –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ë–î `memory/memory_companion.db` + schema versioning
**–¶–µ–ª—å:** –æ—Ç–¥–µ–ª—å–Ω–∞—è –ë–î –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–π legacy.
**–î–µ–π—Å—Ç–≤–∏—è:**
- –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –∏ –≤–µ—Ä—Å–∏—é —Å—Ö–µ–º—ã.
- Fail-fast –ø—Ä–∏ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –≤–µ—Ä—Å–∏–∏ (–±–µ–∑ silent-fallback).
**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- –ü–ª–∞–Ω –≤–∫–ª—é—á–∞–µ—Ç –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã –∏ –æ—Ç–∫–∞–∑ –ø—Ä–∏ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.

### MC1.2 ‚Äî –ï–¥–∏–Ω—ã–π InteractionLog –¥–ª—è ChatLane –∏ CommandLane
**–¶–µ–ª—å:** –æ–¥–∏–Ω audit‚Äë—Ç—Ä–µ–∫ –Ω–∞ –≤—Å—ë.
**–î–µ–π—Å—Ç–≤–∏—è:**
- –í–≤–µ—Å—Ç–∏ `interaction_kind` (`chat|tool`) –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.
**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- –õ—é–±–æ–π –ø—É—Ç—å (—á–∞—Ç –∏–ª–∏ –∫–æ–º–∞–Ω–¥–∞) –æ–±—è–∑—É–µ—Ç—Å—è –ø–∏—Å–∞—Ç—å InteractionLog.

---

## MC2 ‚Äî CommandLane guardrails + blocked –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### MC2.1 ‚Äî CommandLane –≤–Ω—É—Ç—Ä–∏ unified pipeline (–±–µ–∑ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –ø—É—Ç–∏)
**–¶–µ–ª—å:** `/fs /web /sh /project` –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ pipeline.
**–î–µ–π—Å—Ç–≤–∏—è:**
- –ü–∞—Ä—Å–µ—Ä –∫–æ–º–∞–Ω–¥ –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–æ–Ω–∫–∏–º –∏ –æ—Ç–¥–∞—ë—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ pipeline.
**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- –í –ø–ª–∞–Ω–µ –Ω–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ ‚Äú–∫–æ–º–∞–Ω–¥–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è‚Äù –≤–Ω–µ pipeline.

### MC2.2 ‚Äî blocked/denied: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ reason enum
**–¶–µ–ª—å:** –¥–µ–±–∞–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏ –±–µ–∑ –¥–æ–≥–∞–¥–æ–∫.
**–î–µ–π—Å—Ç–≤–∏—è:**
- –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å `tool_status` –∏ `blocked_reason` enum.
**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- –í InteractionLog(kind=tool) –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è blocked —Å–æ–±—ã—Ç–∏—è —Å reason.

---

## MC3 ‚Äî PolicyRule schema + RuleEngine (trigger/action)

### MC3.1 ‚Äî RuleEngine –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ Approved –ø—Ä–∞–≤–∏–ª–∞
**–¶–µ–ª—å:** runtime –ø—Ä–∏–º–µ–Ω—è–µ—Ç policies, –Ω–æ –Ω–µ ‚Äú–æ–±—É—á–∞–µ—Ç—Å—è‚Äù.
**–î–µ–π—Å—Ç–≤–∏—è:**
- RuleEngine —á–∏—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ `PolicyRule` (Approved) –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç pre-gen instructions.
**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- –í –ø–ª–∞–Ω–µ –ø—Ä—è–º–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å/–º–µ–Ω—è—Ç—å PolicyRule –≤–Ω—É—Ç—Ä–∏ runtime pipeline.

### MC3.2 ‚Äî –¢—Ä–∞—Å—Å–∏—Ä—É–µ–º–æ—Å—Ç—å: applied_policy_ids –≤ InteractionLog
**–¶–µ–ª—å:** –ø–æ–Ω–∏–º–∞—Ç—å, —á—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–ª–æ, –∏ —Å—Ç—Ä–æ–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏.
**–î–µ–π—Å—Ç–≤–∏—è:**
- –í ChatLane –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å `applied_policy_ids[]`.
**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- –ú–µ—Ç—Ä–∏–∫–∏ MC7 –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ—Å—á–∏—Ç–∞–Ω—ã –ø–æ –¥–∞–Ω–Ω—ã–º InteractionLog.

---

## MC4 ‚Äî Minimal Feedback UI (üëç üòê üëé + labels) ‚Üí FeedbackEvent

### MC4.1 ‚Äî –Ø–≤–Ω—ã–π —Ñ–∏–¥–±—ç–∫: rating + labels + optional free_text
**–¶–µ–ª—å:** –∑–∞–º–µ–Ω–∏—Ç—å ‚Äú–ø–æ–¥—Å–∫–∞–∑–∫—É‚Äù –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∏–¥–±—ç–∫.
**–î–µ–π—Å—Ç–≤–∏—è:**
- –í–≤–µ—Å—Ç–∏ rating `good|ok|bad`.
- labels –∫–∞–∫ –Ω–∞–±–æ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞ Signals (–ø—Ä–∏–º–µ—Ä: ‚Äú—Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ‚Äù, ‚Äú–Ω–µ –ø–æ –¥–µ–ª—É‚Äù, ‚Äú–Ω–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤‚Äù, ‚Äú–ø—Ä–∏–¥—É–º–∞–ª‚Äù, ‚Äú—Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω–æ‚Äù).
**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- ‚Äú–º–æ–ª—á–∞–Ω–∏–µ –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞‚Äù –Ω–µ —Å–æ–∑–¥–∞—ë—Ç `FeedbackEvent` –∏ —Å—á–∏—Ç–∞–µ—Ç—Å—è `unknown`.
- `FeedbackEvent` ‚Äî —ç—Ç–æ *–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è* –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å—å; –∞–≤—Ç–æ‚Äë–∞–ø–¥–µ–π—Ç—ã `Memory`/`PolicyRule` –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∏–¥–±—ç–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω—ã.

---

## MC5 ‚Äî BatchReview job (‚Äú–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö‚Äù): Intent/Paradox ‚Üí Signals ‚Üí Candidates ‚Üí Report

### MC5.1 ‚Äî BatchReview –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤—Ä—É—á–Ω—É—é
**–¶–µ–ª—å:** –æ—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å —É–ª—É—á—à–µ–Ω–∏–π ‚Äî –æ—Ñ—Ñ–ª–∞–π–Ω‚Äëreview, –∞ –Ω–µ online‚Äë–æ–±—É—á–µ–Ω–∏–µ.
**–î–µ–π—Å—Ç–≤–∏—è:**
- UI –∫–Ω–æ–ø–∫–∞ ‚Äú–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö‚Äù –∑–∞–ø—É—Å–∫–∞–µ—Ç BatchReview –ø–æ —Ñ–∏–ª—å—Ç—Ä—É/–ø–µ—Ä–∏–æ–¥—É.
**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- BatchReview –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –æ–¥–Ω–æ–º—É —Ñ–∏–¥–±—ç–∫—É.
- BatchReview –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –∏ –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç `PolicyRule`/`Memory`: —Ç–æ–ª—å–∫–æ –æ—Ç—á—ë—Ç + `PolicyRuleCandidate[]`.

### MC5.2 ‚Äî IntentAnalysis/ParadoxDetection (deterministic) —É–ª—É—á—à–∞–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤, –Ω–µ –≤—ã–Ω–æ—Å–∏—Ç ‚Äú–≤–µ—Ä–¥–∏–∫—Ç‚Äù
**–¶–µ–ª—å:** —É–º–µ–Ω—å—à–∏—Ç—å –ª–æ–∂–Ω—ã–µ –≤—ã–≤–æ–¥—ã (—Å–∞—Ä–∫–∞–∑–º/–º–∞—Ç/–ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è).
**–î–µ–π—Å—Ç–≤–∏—è:**
- –§–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ intent-–≥–∏–ø–æ—Ç–µ–∑ —Å–æ score.
- –í—ã—Å—Ç–∞–≤–ª—è—Ç—å paradox flags –∏ –ø–æ–Ω–∏–∂–∞—Ç—å confidence –≤—ã–≤–æ–¥–æ–≤.
**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- –í –ø–ª–∞–Ω–µ —è–≤–Ω–æ –∑–∞–ø—Ä–µ—â–µ–Ω—ã ‚Äú—Å–∞—Ä–∫–∞–∑–º=–ø–ª–æ—Ö–æ‚Äù, ‚Äú–º–∞—Ç=–ø–ª–æ—Ö–æ‚Äù, ‚Äú–º–æ–ª—á–∞–Ω–∏–µ=—Ö–æ—Ä–æ—à–æ‚Äù.

### MC5.3 ‚Äî –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PolicyRuleCandidate —Å evidence
**–¶–µ–ª—å:** –ø–æ–ª—É—á–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª, –∞ –Ω–µ –∞–≤—Ç–æ‚Äë–ø—Ä–∞–≤–∫–∏.
**–î–µ–π—Å—Ç–≤–∏—è:**
- –°–æ–±–∏—Ä–∞—Ç—å signals –ø–æ InteractionLog + FeedbackEvent.
- –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ `PolicyRuleCandidate[]` —Å evidence –∏ confidence_suggestion.
**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- –ö–∞–Ω–¥–∏–¥–∞—Ç—ã –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ RuleEngine –¥–æ approve.

---

## MC6 ‚Äî Review UI (Approve/Edit/Reject) + persist Approved

### MC6.1 ‚Äî UI —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ + evidence
**–¶–µ–ª—å:** –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
**–î–µ–π—Å—Ç–≤–∏—è:**
- –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç—ã, evidence, intent/paradox flags, suggested trigger/action.
- –î–µ–π—Å—Ç–≤–∏—è: Approve / Edit / Reject.
**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- Persist –¥–µ–ª–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ Approve.
- –õ—é–±—ã–µ auto‚Äë–∏–∑–º–µ–Ω–µ–Ω–∏—è `PolicyRule`/`Memory` –≤ UI –∑–∞–ø—Ä–µ—â–µ–Ω—ã: —Ç–æ–ª—å–∫–æ —è–≤–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

### MC6.2 ‚Äî Persist Approved ‚Üí PolicyRule (—Å provenance)
**–¶–µ–ª—å:** –ø—Ä–∞–≤–∏–ª–∞ –ø–æ—è–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º.
**–î–µ–π—Å—Ç–≤–∏—è:**
- –ù–∞ Approve: –∑–∞–ø–∏—Å–∞—Ç—å `PolicyRule` —Å `provenance=batch_review_run_id` (+ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ `feedback_id`).
**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- –ü—Ä–∞–≤–∏–ª–æ –±–µ–∑ provenance –∑–∞–ø—Ä–µ—â–µ–Ω–æ (fail-fast).

---

## MC7 ‚Äî –ú–µ—Ç—Ä–∏–∫–∏ (–º–∏–Ω–∏–º—É–º —Å—á–∏—Ç–∞–µ–º—ã–µ)

### MC7.1 ‚Äî Policy hit rate / Rule churn / Feedback resolution
**–¶–µ–ª—å:** –∏–∑–º–µ—Ä—è—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±–µ–∑ ‚Äú—Ñ–µ–π–∫–æ–≤—ã—Ö‚Äù –º–µ—Ç—Ä–∏–∫.
**–î–µ–π—Å—Ç–≤–∏—è:**
- Policy hit rate: –¥–æ–ª—è chat-interactions —Å `applied_policy_ids`.
- Rule churn: —Å–∫–æ–ª—å–∫–æ rules —Å–æ–∑–¥–∞–Ω–æ/–æ–±–Ω–æ–≤–ª–µ–Ω–æ/–ø—Ä–æ—Ç—É—Ö–ª–æ (decay).
- Feedback resolution: –¥–æ–ª—è bad‚Üíok/good –ø–æ labels.
- Unknown rate: –¥–æ–ª—è interaction –±–µ–∑ feedback (–≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ good).
**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- –ú–µ—Ç—Ä–∏–∫–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –∑–∞–ø—Ä–æ—Å–æ–º –∫ `memory/memory_companion.db`.

---

## Deliverable (—á—Ç–æ –¥–æ–ª–∂–µ–Ω —Å–¥–µ–ª–∞—Ç—å Codex –ø–æ —ç—Ç–æ–º—É –ø–ª–∞–Ω—É)

- –ü–ª–∞–Ω —Ç—Ä–µ–±—É–µ—Ç: unified pipeline + InteractionLog –Ω–∞ chat/tool, CommandLane blocked logging, policies —Ç–æ–ª—å–∫–æ Approved, feedback —è–≤–Ω—ã–π, BatchReview –ø–æ –∫–Ω–æ–ø–∫–µ, –∫–∞–Ω–¥–∏–¥–∞—Ç—ã —Å evidence, approve/edit/reject, –º–µ—Ç—Ä–∏–∫–∏.
- –ù–∏–∫–∞–∫–∏—Ö auto‚Äëupdates memory/policies –±–µ–∑ approve.

---

## Appendix: Legacy import (–ø–æ–∑–∂–µ, –æ—Ç–¥–µ–ª—å–Ω–æ–π –∑–∞–¥–∞—á–µ–π)

**–°—Ç–∞—Ç—É—Å:** NOT IMPLEMENTED –Ω–∞ –ø–µ—Ä–≤–æ–º –∑–∞—Ö–æ–¥–µ.

- –≠–∫—Å–ø–æ—Ä—Ç —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ `memory/memory.db` –∏ `memory/feedback.db` (read-only).
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥ –Ω–æ–≤—É—é —Å—Ö–µ–º—É.
- –ò–º–ø–æ—Ä—Ç –≤ `memory/memory_companion.db`.
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ feature-flag (NOT IMPLEMENTED).
