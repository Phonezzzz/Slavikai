# E2E_SCENARIOS — Manager → Worker → Verifier

Документ фиксирует 4 эталонных сценария для будущей интеграции.

## S1 — Небольшое изменение кода + зелёный Verifier

**Цель:** проверить, что успешные изменения принимаются только после зелёной проверки.

**Шаги:**
1) Manager формирует `TaskPacket` (цель: «переименовать переменную/исправить мелкий баг»).
2) Worker делает правки в изолированной области, возвращает `WorkResult`.
3) Verifier запускает `scripts/check.sh`.
4) Verifier возвращает `passed`.
5) Менеджер применяет изменения в основной workspace и формирует финальный ответ.

**Ожидаемые артефакты:**
- `WorkResult.status = success`
- `VerificationResult.status = passed`
- Трасса содержит шаги Worker + Verifier (stdout/stderr кратко).

## S2 — Намеренная ошибка + retry + диагностический вывод

**Цель:** проверить bounded‑retry и корректный стоп при ошибках.

**Шаги:**
1) Manager формирует `TaskPacket` (цель: «изменить поведение функции»).
2) Worker делает правки в изолированной области, возвращает `WorkResult`.
3) Verifier запускает `scripts/check.sh`.
4) Verifier возвращает `failed` (например, ломаются тесты).
5) Manager инициирует повторную попытку Worker с диагностикой (stderr + краткое summary).
6) Worker исправляет, повтор Verifier.
7) Если Verifier снова `failed` и лимит исчерпан → остановка и отчёт.

**Ожидаемые артефакты:**
- Минимум 1 повтор (если лимит позволяет).
- При остановке: финальный отчёт содержит последний `VerificationResult` и причины остановки.
- Основной workspace не меняется, если Verifier не стал зелёным.

## S3 — Ошибка Verifier (инфраструктура)

**Цель:** проверить, что при `error` Verifier цикл останавливается без попыток «угадать».

**Шаги:**
1) Manager формирует `TaskPacket`.
2) Worker возвращает `WorkResult`.
3) Verifier запускается и падает с `error` (например, timeout или отсутствует скрипт).
4) Manager возвращает отчёт с причиной и инструкцией для ручного разбора.

**Ожидаемые артефакты:**
- `VerificationResult.status = error`
- Нет ретраев (это не проблема кода, а инфраструктуры).

## S4 — Опасное действие требует подтверждения

**Цель:** проверить, что safe‑mode блокирует риск до одобрения.

**Шаги:**
1) Manager формирует `TaskPacket`.
2) Worker планирует действие, требующее approval (например, удаление/перезапись файла).
3) Возвращается `approval_required` без выполнения.
4) При отказе — остановка и отчёт. При согласии — повторный запуск цикла.

**Ожидаемые артефакты:**
- Нет выполнения риск‑действия без явного approve.
- В trace есть событие `approval_required`.
