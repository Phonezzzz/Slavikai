# PHASE 4 — DualBrain + Critic Policy (A + D)

Документ описывает, как включается критик и как его вывод/статусы попадают в trace и HTTP‑ответы.

## 1) Режимы

- `slavik-single` → режим `single`, критик не используется.
- `slavik-dual` → режим `dual`, критик включается по политике A + D.
- `slavik-critic` → режим `critic-only`, возвращается только критика.

## 2) Политика A + D (когда запускать критика)

Политика реализована в `core/critic_policy.py`:

**A (always):** критик включается, если задача содержит:
- намерение выполнить инструменты (tool intent),
- намерение изменить код (code change intent).

**D (risk‑based):** критик включается при наличии риск‑триггеров:
- удаление/перезапись файлов;
- конфиги/секреты/ключи;
- установка/обновление зависимостей;
- системные команды/сервисы/сети/диски;
- операции вне workspace;
- `sudo`;
- `git commit/push/publish`.

Если триггеров нет — в `dual` критик не запускается (status=`disabled`).

## 3) CriticDecision (структура)

Функция `decide_critic(...)` возвращает:

- `should_run_critic: bool`
- `reasons: list[str]` (например: `mode=dual`, `task:tools`, `risk:sudo`, `risk:delete`)

`reasons` сохраняются в trace и (опционально) в `slavik_meta.critic_reasons`.

## 4) Critic status (semantics)

`slavik_meta.critic_status` принимает значения:

- `disabled` — критик выключен (single или нет триггеров).
- `ok` — критик отработал, серьёзных рисков не отметил.
- `risky` — есть риск‑триггеры или критик явно отметил риск.
- `bad_plan` — критик явно отклонил план/ответ.
- `uncertain` — критик запускался, но не вернул осмысленного ответа.
- `internal_error` — ошибка критика (см. ниже).

## 5) Где хранится вывод критика

- Полный текст критики пишется в trace (события `critic_review` / `critic_response`).
- Решение о запуске критика фиксируется как `critic_decision`.
- Для UI детали должны подтягиваться через `/slavik/trace/{trace_id}`.
- В HTTP‑ответе доступно только краткое мета‑состояние.

## 6) Ошибки критика (no silent fallback)

Если критик падает при обязательном запуске:

- выполнение не продолжается,
- `critic_status` = `internal_error`,
- пользователю возвращается явная ошибка в тексте ответа,
- подробности фиксируются в trace (`critic_error`).

## 7) Ограничения Phase 4

- Session approvals — только в Phase 5.
- Streaming не поддерживается.
- Open WebUI не содержит логики критика (UI‑only).
